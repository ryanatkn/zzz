import{k as o,aF as Et,i as r,aC as Tt,j as l,l as n,ax as Ps,bo as Dt,ay as xe,a7 as I,bm as $s}from"./DsYFF3e0.js";import{V as ze,_ as q,l as c,v as g,X as y,k as _,Y as O,j as h,m as f,C as b,Z as m,$ as D,h as v,i as At,a0 as k,a1 as B,r as W,o as A,S as L,a2 as js,E as qe,a3 as Ne,H as j,a4 as Je,U as w,J as G,t as Ce,n as de,p as ce,q as E,a as Oe,a5 as zs,a6 as Ns,a7 as te,a8 as Js,a9 as U,aa as Jt,ab as Ot,b as Cs,f as Ms,ac as Is,K as Ls,T as V,ad as Rt,c as Us}from"./23rF6zAW.js";import{g as Fs}from"./BqUwps9A.js";import{p as Me}from"./DTs_Hi8X.js";const Ws=!0,tn=(i=0)=>new Promise(e=>setTimeout(e,i)),sn=i=>i&&typeof i.then=="function",Vs=()=>{let i,e;return{promise:new Promise((s,a)=>{i=s,e=a}),resolve:i,reject:e}};var St=!1;class Ie extends Date{#e=o(super.getTime());#t=new Map;#s=Et;constructor(...e){super(...e),St||this.#i()}#i(){St=!0;var e=Ie.prototype,t=Date.prototype,s=Object.getOwnPropertyNames(t);for(const a of s)(a.startsWith("get")||a.startsWith("to")||a==="valueOf")&&(e[a]=function(...d){if(d.length>0)return r(this.#e),t[a].apply(this,d);var u=this.#t.get(a);if(u===void 0){const S=Et;Tt(this.#s),u=l(()=>(r(this.#e),t[a].apply(this,d))),this.#t.set(a,u),Tt(S)}return r(u)}),a.startsWith("set")&&(e[a]=function(...d){var u=t[a].apply(this,d);return n(this.#e,t.getTime.call(this)),u})}}var Hs=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],Ys=["difference","intersection","symmetricDifference","union"],Pt=!1;class se extends Set{#e=new Map;#t=o(0);#s=o(0);#i=Dt||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#s.v=super.size}Pt||this.#n()}#r(e){return Dt===this.#i?o(e):Ps(e)}#n(){Pt=!0;var e=se.prototype,t=Set.prototype;for(const s of Hs)e[s]=function(...a){return r(this.#t),t[s].apply(this,a)};for(const s of Ys)e[s]=function(...a){r(this.#t);var d=t[s].apply(this,a);return new se(d)}}has(e){var t=super.has(e),s=this.#e,a=s.get(e);if(a===void 0){if(!t)return r(this.#t),!1;a=this.#r(!0),s.set(e,a)}return r(a),t}add(e){return super.has(e)||(super.add(e),n(this.#s,super.size),xe(this.#t)),this}delete(e){var t=super.delete(e),s=this.#e,a=s.get(e);return a!==void 0&&(s.delete(e),n(a,!1)),t&&(n(this.#s,super.size),xe(this.#t)),t}clear(){if(super.size!==0){super.clear();var e=this.#e;for(var t of e.values())n(t,!1);e.clear(),n(this.#s,0),xe(this.#t)}}keys(){return this.values()}values(){return r(this.#t),super.values()}entries(){return r(this.#t),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return r(this.#s)}}const Le=Object.freeze({}),X=q(["ollama","claude","chatgpt","gemini"]),Gs=c({type:y("ollama"),value:O().optional().default({})}),Xs=c({type:y("claude"),value:O().optional().default({})}),Bs=c({type:y("chatgpt"),value:O().optional().default({})}),Ks=c({type:y("gemini"),value:c({text:_(),candidates:h(O()).nullable().optional(),function_calls:h(O()).nullable().optional(),prompt_feedback:O().nullable().optional(),usage_metadata:O().nullable().optional()})}),Qs=ze("type",[Gs,Xs,Bs,Ks]),Ue=ze("available",[c({name:_(),available:y(!0),checked_at:g()}),c({name:_(),available:y(!1),error:_(),checked_at:g()})]),Ct=b.extend({name:X,title:_(),url:_(),homepage:_(),company:_(),api_key_url:_().nullable()}).meta({cell_class_name:"Provider"});class Mt extends f{#e=o();get name(){return r(this.#e)}set name(e){n(this.#e,e,!0)}#t=o();get title(){return r(this.#t)}set title(e){n(this.#t,e,!0)}#s=o();get url(){return r(this.#s)}set url(e){n(this.#s,e,!0)}#i=o();get homepage(){return r(this.#i)}set homepage(e){n(this.#i,e,!0)}#r=o();get company(){return r(this.#r)}set company(e){n(this.#r,e,!0)}#n=o();get api_key_url(){return r(this.#n)}set api_key_url(e){n(this.#n,e,!0)}#a=l(()=>this.app.models.items.where("provider_name",this.name));get models(){return r(this.#a)}set models(e){n(this.#a,e)}#o=l(()=>this.app.lookup_provider_status(this.name));get status(){return r(this.#o)}set status(e){n(this.#o,e)}#l=l(()=>this.status?.available??!1);get available(){return r(this.#l)}set available(e){n(this.#l,e)}constructor(e){super(Ct,e),this.init()}}const Zs="http://127.0.0.1:11434";m({status:_()});const ei=m({status:_(),digest:_().optional(),total:g().optional(),completed:g().optional()}),Fe=m({families:h(_()),family:_(),format:_(),parameter_size:_(),parent_model:_(),quantization_level:_()}),It=m({details:Fe.optional(),digest:_(),model:_(),modified_at:_(),name:_(),size:g()}),ti=m({models:h(It)}),Lt=m({capabilities:h(_()).optional(),details:Fe.optional(),license:_().optional(),model_info:O().optional(),modelfile:_().optional(),modified_at:_().optional(),template:_().optional(),tensors:h(O()).optional()}),si=m({details:Fe.optional(),digest:_(),expires_at:_(),model:_(),name:_(),size:g(),size_vram:g()}),ii=m({models:h(si)}),ri=D().optional(),ni=D().optional(),ai=m({model:_(),system:_().optional(),template:_().optional(),options:O().optional()}),oi=m({model:_(),insecure:v().optional(),stream:v().optional()});m({model:_(),insecure:v().optional(),stream:v().optional()});const li=m({model:_(),from:_().optional(),stream:v().optional(),quantize:_().optional(),template:_().optional(),license:k([_(),h(_())]).optional(),system:_().optional(),parameters:At(_(),B()).optional(),messages:h(O()).optional(),adapters:At(_(),_()).optional()}),_i=m({model:_()}),di=m({source:_(),destination:_()}),ci=i=>{if(!i)return;const e=/^(\d+(?:\.\d+)?)[BM]?$/i.exec(i);if(!e)return;const t=parseFloat(e[1]);return i.toUpperCase().endsWith("M")?t/1e3:t},rn={label:"the Ollama logo",paths:[{d:"m 28.64064,0.03589683 c -0.93326,0.15075969 -2.053195,0.63892949 -2.842876,1.24197237 -2.390589,1.81629 -4.242785,5.6714383 -5.025299,10.4741988 -0.294335,1.816276 -0.495344,4.336156 -0.495344,6.260177 0,2.268563 0.265618,5.168822 0.646113,7.171775 0.08615,0.44514 0.129222,0.840038 0.09333,0.86873 -0.02872,0.02869 -0.380494,0.315849 -0.775347,0.631698 -1.349647,1.076838 -2.89315,2.735248 -3.955641,4.250083 -2.038847,2.893114 -3.359791,6.181128 -3.912576,9.741896 -0.215372,1.40709 -0.272803,4.249965 -0.1005,5.657056 0.380487,3.244916 1.356835,5.98731 3.029546,8.500047 l 0.545608,0.811229 -0.157935,0.265609 c -1.119934,1.880923 -2.074742,4.601767 -2.51984,7.214869 -0.351773,2.067598 -0.394848,2.620363 -0.394848,5.391448 0,2.792751 0.0359,3.345515 0.36613,5.276676 0.394848,2.311658 1.198898,4.759635 2.096274,6.389355 0.294348,0.531216 1.012251,1.636745 1.098398,1.694246 0.02871,0.01429 -0.05743,0.279896 -0.193831,0.588603 -1.033787,2.261418 -1.916805,5.269418 -2.282941,7.803703 -0.258441,1.737227 -0.294336,2.297255 -0.294336,4.127935 0,2.333091 0.12922,3.46743 0.617399,5.326802 l 0.07179,0.272701 h 3.072624 3.079814 l -0.201023,-0.38044 C 18.96336,97.31901 18.848496,93.05464 19.918166,88.797531 c 0.488179,-1.967115 1.040968,-3.410041 2.074743,-5.398709 l 0.617399,-1.20601 v -0.73944 c 0,-0.689202 -0.01436,-0.768132 -0.236904,-1.220417 -0.172306,-0.344658 -0.402031,-0.638959 -0.811241,-1.041002 -0.696366,-0.674794 -1.198891,-1.385542 -1.600922,-2.261417 -1.766037,-3.833634 -2.110638,-9.526527 -0.868661,-14.379615 0.516894,-2.024501 1.371197,-3.826375 2.268573,-4.809875 0.61022,-0.674911 0.926091,-1.428639 0.926091,-2.211177 0,-0.811228 -0.287156,-1.478879 -0.93327,-2.175222 -1.852195,-1.981404 -2.993655,-4.393661 -3.402864,-7.200582 -0.581504,-3.998761 0.473819,-8.35647 2.871612,-11.809493 2.347553,-3.388613 5.642699,-5.563836 9.325611,-6.145293 0.825518,-0.136435 2.369043,-0.114887 3.230513,0.0431 0.94052,0.165126 1.529122,0.11477 2.132244,-0.172388 0.746584,-0.351684 1.119934,-0.78968 1.557813,-1.794729 0.387638,-0.897306 0.689199,-1.385542 1.500429,-2.397734 0.976356,-1.213272 1.916758,-2.038906 3.424331,-3.036811 1.723057,-1.127078 3.682913,-1.945451 5.635625,-2.34035 0.71063,-0.143578 1.040885,-0.165127 2.369042,-0.165127 1.328159,0 1.658412,0.02155 2.369043,0.165127 2.864422,0.581574 5.707414,2.060455 7.975974,4.156628 0.48812,0.452284 1.658295,1.90247 2.031646,2.505594 0.143578,0.236799 0.394899,0.739439 0.552764,1.112673 0.43788,1.005049 0.81123,1.443045 1.557814,1.794729 0.581573,0.280013 1.191723,0.337514 2.096291,0.186676 1.428638,-0.24406 2.527025,-0.222512 3.926972,0.06465 4.766895,0.961951 8.916378,4.888924 10.754204,10.151198 1.60091,4.616055 1.148626,9.447594 -1.234819,13.137535 -0.402043,0.62467 -0.804086,1.127194 -1.385543,1.744605 -1.25637,1.342445 -1.25637,3.008001 -0.0071,4.386399 2.053194,2.247013 3.338256,7.774895 2.950501,12.649414 -0.258349,3.216227 -1.083983,6.095053 -2.218322,7.724656 -0.200962,0.287156 -0.617293,0.775276 -0.933258,1.076837 -0.409186,0.402043 -0.638842,0.696344 -0.811229,1.041002 -0.222512,0.452283 -0.236917,0.531215 -0.236917,1.220415 v 0.739441 l 0.61741,1.206011 c 1.033858,1.988666 1.586623,3.431592 2.074742,5.398709 1.055406,4.199725 0.962068,8.3779 -0.244058,10.754203 -0.100479,0.200964 -0.186676,0.387616 -0.186676,0.409174 0,0.02151 1.371255,0.03581 3.051097,0.03581 h 3.043955 l 0.07893,-0.308691 c 0.0431,-0.16501 0.114887,-0.416331 0.150721,-0.559909 0.07905,-0.315848 0.236917,-1.249107 0.366208,-2.146531 0.12203,-0.904566 0.12203,-4.235677 0,-5.240725 -0.459427,-3.64696 -1.227676,-6.540075 -2.483929,-9.275324 -0.136434,-0.308706 -0.222628,-0.574314 -0.193936,-0.588601 0.03596,-0.02155 0.236917,-0.308706 0.452284,-0.631816 1.565074,-2.369042 2.527025,-5.34835 3.015262,-9.282468 0.129173,-1.084097 0.129173,-5.743249 0,-6.784251 -0.344658,-2.684891 -0.760989,-4.50843 -1.450188,-6.353399 -0.287158,-0.768132 -1.048145,-2.390592 -1.371138,-2.914664 l -0.157983,-0.265609 0.545621,-0.811229 c 1.672699,-2.512737 2.649055,-5.25513 3.029549,-8.500046 0.17227,-1.407091 0.114887,-4.249967 -0.100478,-5.657057 -0.560025,-3.568028 -1.873779,-6.841637 -3.912567,-9.741896 -1.06255,-1.514833 -2.606076,-3.173244 -3.955665,-4.250082 -0.394899,-0.315849 -0.746701,-0.603005 -0.775394,-0.631698 -0.03584,-0.02869 0.0072,-0.423591 0.09334,-0.86873 0.86873,-4.529978 0.839922,-10.179774 -0.07179,-14.594937 C 78.211992,6.7411284 76.776209,3.6828521 74.923978,1.916815 73.445098,0.50972185 71.937525,-0.09331726 70.128391,0.02154733 65.978909,0.26563406 62.63351,5.0396902 61.312495,12.563307 c -0.215367,1.213271 -0.401926,2.634768 -0.401926,3.022406 0,0.150723 -0.02881,0.272752 -0.06465,0.272752 -0.03596,0 -0.315849,-0.143579 -0.617411,-0.322992 -3.20182,-1.895328 -6.762702,-2.90752 -10.230131,-2.90752 -3.467429,0 -7.028312,1.012191 -10.230132,2.90752 -0.301562,0.179414 -0.581457,0.322992 -0.61741,0.322992 -0.03584,0 -0.06465,-0.122029 -0.06465,-0.272752 0,-0.402042 -0.193819,-1.866517 -0.401926,-3.022405 C 37.485228,5.8078345 34.735693,1.3353005 31.081588,0.20818971 30.579064,0.05743001 29.150424,-0.04307254 28.64064,0.03589683 Z m 1.220532,5.84373997 c 1.033741,0.8184078 2.182367,3.1587706 2.842875,5.7791292 0.122029,0.473797 0.251203,1.019416 0.287157,1.220381 0.02869,0.193935 0.107629,0.631814 0.17227,0.969212 0.280012,1.521976 0.409187,3.165982 0.423591,5.168934 l 0.0071,1.974259 -0.495379,0.73218 -0.495263,0.739441 h -1.155888 c -1.34959,0 -2.692152,0.172388 -3.977213,0.516927 -0.459428,0.114888 -0.904568,0.229773 -0.990644,0.251321 -0.136434,0.02869 -0.157983,-0.01441 -0.236917,-0.603122 -0.423591,-3.194676 -0.402041,-6.733894 0.06465,-9.677365 0.516812,-3.2807698 1.722939,-6.2528882 2.900258,-7.1287279 0.280013,-0.2082004 0.330254,-0.2010215 0.653364,0.057438 z M 70.795986,5.829374 c 0.710748,0.5240722 1.493285,1.9168055 2.074742,3.697201 1.170175,3.560796 1.500429,8.449719 0.883019,13.101725 -0.07893,0.588719 -0.100478,0.631815 -0.236917,0.603122 -0.08608,-0.02155 -0.531215,-0.136433 -0.990643,-0.25132 -1.285061,-0.34454 -2.627624,-0.516928 -3.977214,-0.516928 h -1.155888 l -0.495262,-0.73944 -0.495381,-0.73218 0.0071,-1.97426 c 0.0144,-2.785489 0.272869,-4.960711 0.890162,-7.380065 0.653363,-2.5988207 1.809134,-4.9391832 2.835731,-5.7575911 0.323111,-0.2584533 0.37335,-0.2656324 0.660507,-0.050263 z"},{d:"m 48.885535,41.961366 c -1.55793,0.15084 -1.981404,0.208225 -2.728105,0.359063 -1.213273,0.251204 -2.83573,0.81123 -3.962809,1.363995 -3.919713,1.916759 -6.619008,5.111436 -7.444642,8.808636 -0.165127,0.732296 -0.186675,0.976355 -0.186675,2.211177 0,1.220415 0.02155,1.486023 0.179532,2.182367 1.098385,4.831539 5.549313,8.399566 11.306968,9.052812 1.249108,0.136434 6.647818,0.136434 7.896926,0 4.623316,-0.524072 8.600528,-3.029549 10.388114,-6.547335 0.473715,-0.940403 0.703487,-1.55067 0.918854,-2.505477 0.157984,-0.696344 0.179531,-0.961952 0.179531,-2.182367 0,-1.234822 -0.02155,-1.478881 -0.186674,-2.211177 C 64.047569,47.123161 58.835654,42.894743 52.446301,42.090657 51.613523,41.99018 49.431156,41.903982 48.885535,41.961366 Z m 2.684891,3.905425 c 2.132243,0.229772 4.278774,0.990761 6.001715,2.139388 0.926115,0.61741 2.232725,1.909615 2.792633,2.756797 0.6892,1.048028 1.083982,2.117722 1.263514,3.417187 0.07893,0.595862 0.03595,1.048146 -0.179532,2.010097 -0.337397,1.435783 -1.385543,2.936212 -2.799778,3.984358 -0.660507,0.480975 -2.031645,1.177436 -2.871566,1.450187 -1.593766,0.509668 -2.634768,0.603005 -6.353517,0.574313 -2.426426,-0.02155 -2.857279,-0.0431 -3.553622,-0.17227 -2.376185,-0.44514 -4.257109,-1.392803 -5.621104,-2.83573 -1.105646,-1.163032 -1.60817,-2.225465 -1.880923,-3.94126 -0.122029,-0.796943 0.107629,-2.117839 0.574314,-3.230631 0.56717,-1.35685 2.031646,-3.043836 3.481833,-4.013048 1.679843,-1.119935 3.891019,-1.916759 5.922665,-2.132127 0.782536,-0.08619 2.44083,-0.08619 3.223368,-0.0072 z"},{d:"m 47.25605,51.107635 c -0.545621,0.294302 -0.926116,1.040884 -0.811229,1.593649 0.129174,0.595863 0.653246,1.198984 1.471618,1.694365 0.437997,0.265608 0.46669,0.301444 0.488238,0.567051 0.01429,0.157986 -0.0431,0.610268 -0.122031,1.012311 -0.08619,0.39478 -0.150838,0.811228 -0.150838,0.926116 0.0072,0.308707 0.294417,0.81123 0.595862,1.055289 0.265724,0.215367 0.315965,0.222509 1.06255,0.244058 0.682054,0.02155 0.825633,0.0071 1.098385,-0.12203 0.703603,-0.344658 0.883018,-0.976357 0.624554,-2.189628 -0.215367,-1.012191 -0.172271,-1.170175 0.366206,-1.478881 0.567053,-0.330253 1.170176,-0.91171 1.34959,-1.306609 0.344658,-0.753728 0.02869,-1.608054 -0.732296,-2.002953 -0.186558,-0.09333 -0.41633,-0.136317 -0.753728,-0.136317 -0.524073,0 -0.86147,0.12203 -1.478881,0.516811 l -0.351801,0.222629 -0.222511,-0.136434 c -0.911711,-0.538477 -1.076837,-0.603006 -1.62972,-0.595862 -0.394783,0 -0.610149,0.03584 -0.803968,0.136435 z"},{d:"m 29.825219,42.772714 c -1.270657,0.402043 -2.218321,1.335301 -2.706439,2.66346 -0.236916,0.631815 -0.351803,1.629721 -0.251321,2.16808 0.236916,1.285061 1.292205,2.455235 2.491189,2.778346 1.507573,0.394783 2.634651,0.136317 3.632556,-0.854327 0.581457,-0.567169 0.897423,-1.06255 1.213271,-1.866633 0.229655,-0.567054 0.24406,-0.667536 0.24406,-1.471621 l 0.0071,-0.861468 -0.301444,-0.617413 c -0.481093,-0.976353 -1.349708,-1.701507 -2.354755,-1.967115 -0.567169,-0.143577 -1.478881,-0.136317 -1.974261,0.02869 z"},{d:"m 68.168479,42.751283 c -0.983501,0.265608 -1.859374,0.997788 -2.326062,1.959855 l -0.301445,0.617413 0.0071,0.861468 c 0,0.804085 0.01441,0.904567 0.24406,1.471621 0.315967,0.804086 0.631815,1.299464 1.213272,1.866633 0.997904,0.990644 2.124982,1.24911 3.632673,0.854327 0.868613,-0.229772 1.737227,-0.96207 2.153675,-1.816394 0.358945,-0.725035 0.445022,-1.249108 0.330253,-2.074741 -0.265609,-1.888068 -1.371255,-3.259205 -3.015263,-3.740182 -0.480975,-0.143577 -1.414233,-0.143577 -1.938306,0 z"}]},ie=async(i,e)=>{Me.url.pathname!==i&&await Fs(i,e)},C=_().trim(),Ut=b.extend({name:C,provider_name:X,tags:h(_()).default(()=>[]),architecture:_().optional(),parameter_count:g().optional(),context_window:g().optional(),output_token_limit:g().optional(),embedding_length:g().optional(),filesize:g().optional(),cost_input:g().optional(),cost_output:g().optional(),training_cutoff:_().optional(),ollama_list_response_item:It.optional(),ollama_show_response:Lt.optional(),ollama_show_response_loaded:v().default(!1),ollama_show_response_loading:v().default(!1),ollama_show_response_error:_().optional()}).meta({cell_class_name:"Model"});class re extends f{#e=o();get name(){return r(this.#e)}set name(e){n(this.#e,e,!0)}#t=o();get provider_name(){return r(this.#t)}set provider_name(e){n(this.#t,e,!0)}#s=o();get tags(){return r(this.#s)}set tags(e){n(this.#s,e,!0)}#i=o();get architecture(){return r(this.#i)}set architecture(e){n(this.#i,e,!0)}#r=o();get parameter_count(){return r(this.#r)}set parameter_count(e){n(this.#r,e,!0)}#n=o();get context_window(){return r(this.#n)}set context_window(e){n(this.#n,e,!0)}#a=o();get output_token_limit(){return r(this.#a)}set output_token_limit(e){n(this.#a,e,!0)}#o=o();get embedding_length(){return r(this.#o)}set embedding_length(e){n(this.#o,e,!0)}#l=o();get filesize(){return r(this.#l)}set filesize(e){n(this.#l,e,!0)}#_=o();get cost_input(){return r(this.#_)}set cost_input(e){n(this.#_,e,!0)}#d=o();get cost_output(){return r(this.#d)}set cost_output(e){n(this.#d,e,!0)}#c=o();get training_cutoff(){return r(this.#c)}set training_cutoff(e){n(this.#c,e,!0)}#h=o();get ollama_list_response_item(){return r(this.#h)}set ollama_list_response_item(e){n(this.#h,e)}#u=o();get ollama_show_response(){return r(this.#u)}set ollama_show_response(e){n(this.#u,e)}#p=o(!1);get ollama_show_response_loaded(){return r(this.#p)}set ollama_show_response_loaded(e){n(this.#p,e,!0)}#m=o(!1);get ollama_show_response_loading(){return r(this.#m)}set ollama_show_response_loading(e){n(this.#m,e,!0)}#f=o();get ollama_show_response_error(){return r(this.#f)}set ollama_show_response_error(e){n(this.#f,e,!0)}#v=l(()=>this.provider_name==="ollama"?!!this.ollama_list_response_item:void 0);get downloaded(){return r(this.#v)}set downloaded(e){n(this.#v,e)}#g=l(()=>this.app.providers.find_by_name(this.provider_name));get provider(){return r(this.#g)}set provider(e){n(this.#g,e)}#b=l(()=>this.context_window?(this.context_window/1e3).toFixed(0)+"k":null);get context_window_formatted(){return r(this.#b)}set context_window_formatted(e){n(this.#b,e)}#y=l(()=>{const e=this.ollama_list_response_item?.modified_at||this.ollama_show_response?.modified_at;return e===void 0?void 0:typeof e=="string"?new Date(e):e});get ollama_modified_at(){return r(this.#y)}set ollama_modified_at(e){n(this.#y,e)}#w=l(()=>this.provider_name==="ollama"&&!!this.app.ollama.list_response&&this.app.ollama.list_response.models.some(e=>e.name===this.name)&&!this.ollama_show_response_loaded&&!this.ollama_show_response_loading&&!this.ollama_show_response_error);get needs_ollama_details(){return r(this.#w)}set needs_ollama_details(e){n(this.#w,e)}#k=l(()=>this.provider_name==="ollama"?this.app.ollama.running_model_names.has(this.name):!1);get loaded(){return r(this.#k)}set loaded(e){n(this.#k,e)}constructor(e){super(Ut,e),this.init()}async navigate_to_download(){if(this.provider_name!=="ollama"){console.error(`Download not supported for provider: ${this.provider_name}`);return}if(this.downloaded){console.error(`Model ${this.name} is already downloaded`);return}this.app.ollama.pull_model_name=this.name,this.app.ollama.set_manager_view("pull"),await ie(W("/providers/ollama"))}async navigate_to_provider_model_view(){if(this.provider_name!=="ollama"){console.error(`provider model view not supported for provider: ${this.provider_name}`);return}await Promise.all([this.app.ollama.select(this),ie(W("/providers/ollama"))])}}A(re);class z{by_id=new L;#e=l(()=>Array.from(this.by_id.values()));get values(){return r(this.#e)}set values(e){n(this.#e,e)}#t=l(()=>Array.from(this.by_id.keys()));get keys(){return r(this.#t)}set keys(e){n(this.#t,e)}#s=l(()=>this.by_id.size);get size(){return r(this.#s)}set size(e){n(this.#s,e)}#i=o(I({}));get indexes(){return r(this.#i)}set indexes(e){n(this.#i,e,!0)}#r=new Map;#n=[];#a;constructor(e){if(this.#a=e?.validate??!1,e?.indexes){this.#n=e.indexes;for(const t of this.#n)this.indexes[t.key]=t.compute(this),t.type?this.#r.set(t.key,t.type):typeof this.indexes[t.key]=="function"?this.#r.set(t.key,"dynamic"):this.indexes[t.key]instanceof Array?this.#r.set(t.key,"derived"):this.indexes[t.key]instanceof Map&&Array.isArray([...this.indexes[t.key].values()].length>0?[...this.indexes[t.key].values()][0]:[])?this.#r.set(t.key,"multi"):this.#r.set(t.key,"single");if(e.index_types){if(e.index_types.single)for(const t of e.index_types.single)this.#r.set(t,"single");if(e.index_types.multi)for(const t of e.index_types.multi)this.#r.set(t,"multi");if(e.index_types.derived)for(const t of e.index_types.derived)this.#r.set(t,"derived");if(e.index_types.dynamic)for(const t of e.index_types.dynamic)this.#r.set(t,"dynamic")}}e?.initial_items&&this.add_many(e.initial_items)}toJSON(){return js(this.values)}get_index(e){return this.indexes[e]}single_index(e){return this.#o(e,"single"),this.indexes[e]}multi_index(e){return this.#o(e,"multi"),this.indexes[e]}derived_index(e){return this.#o(e,"derived"),this.indexes[e]}dynamic_index(e){return this.#o(e,"dynamic"),this.indexes[e]}#o(e,t){if(this.indexes[e]===void 0)throw new Error(`Index not found: ${e}`);const a=this.#r.get(e);if(a!==t)throw new Error(`Index type mismatch: ${e} is a ${a||"unknown"} index, not a ${t} index`)}query(e,t){const s=this.indexes[e];if(!s)return;const a=this.#n.find(d=>d.key===e);if(this.#a&&a?.query_schema)try{a.query_schema.parse(t)}catch(d){console.error(`Query validation failed for index ${e}:`,d)}return s instanceof Map?s.get(t):typeof s=="function"?s(t):s}add(e){const{by_id:t}=this;t.has(e.id)||(t.set(e.id,e),this.#l(e))}add_many(e){if(e.length)for(const t of e)this.by_id.set(t.id,t),this.#l(t)}#l(e){for(const t of this.#n)if(t.onadd&&(!t.matches||t.matches(e))){const s=t.onadd(this.indexes[t.key],e,this);this.indexes[t.key]=s}}#_(e){for(const t of this.#n)if(t.onremove&&(!t.matches||t.matches(e))){const s=t.onremove(this.indexes[t.key],e,this);this.indexes[t.key]=s}}remove(e){const t=this.by_id.get(e);return t?(this.#_(t),this.by_id.delete(e),!0):!1}remove_many(e){if(!e.length)return 0;let t=0;const s=[];for(const a of e){const d=this.by_id.get(a);d&&(s.push(d),t++)}if(t===0)return 0;for(const a of s)this.#_(a);for(const a of s)this.by_id.delete(a.id);return t}get(e){return this.by_id.get(e)}has(e){return this.by_id.has(e)}clear(){this.by_id.clear();for(const e of this.#n)this.indexes[e.key]=e.compute(this)}where(e,t){return this.#o(e,"multi"),this.indexes[e].get(t)||qe}first(e,t,s){return s<=0?qe:this.where(e,t).slice(0,s)}latest(e,t,s){if(s<=0)return qe;const a=this.where(e,t);return a.slice(-Math.min(s,a.length))}by(e,t){this.#o(e,"single");const a=this.indexes[e].get(t);if(!a)throw new Error(`Item not found for index ${e} with value ${String(t)}`);return a}by_optional(e,t){return this.#o(e,"single"),this.indexes[e].get(t)}}c({id:Ne});const H=i=>({key:i.key,type:"single",extractor:i.extractor,query_schema:i.query_schema,matches:i.matches,compute:e=>{const t=new L;for(const s of e.by_id.values()){if(!N(s,i.matches))continue;const a=i.extractor(s);a!==void 0&&t.set(a,s)}return t},onadd:(e,t)=>{if(!N(t,i.matches))return e;const s=i.extractor(t);return s!==void 0&&e.set(s,t),e},onremove:(e,t,s)=>{if(!N(t,i.matches))return e;const a=i.extractor(t);if(a===void 0)return e;const d=e.get(a);if(!d||d.id!==t.id)return e;let u;for(const S of s.by_id.values())if(S.id!==t.id&&i.extractor(S)===a){u=S;break}return u?e.set(a,u):e.delete(a),e}}),K=i=>({key:i.key,type:"multi",extractor:i.extractor,query_schema:i.query_schema,matches:i.matches,compute:e=>{const t=new L;for(const s of e.by_id.values()){if(!N(s,i.matches))continue;const a=i.extractor(s);if(a!==void 0)if(Array.isArray(a))for(const d of a)ee(t,d,s,i.sort);else ee(t,a,s,i.sort)}return t},onadd:(e,t)=>{if(!N(t,i.matches))return e;const s=i.extractor(t);if(s===void 0)return e;if(Array.isArray(s))for(const a of s)ee(e,a,t,i.sort);else ee(e,s,t,i.sort);return e},onremove:(e,t)=>{if(!N(t,i.matches))return e;const s=i.extractor(t);if(s===void 0)return e;if(Array.isArray(s))for(const a of s)$t(e,a,t);else $t(e,s,t);return e}}),Q=i=>({key:i.key,type:"derived",matches:i.matches,query_schema:i.query_schema,compute:e=>{const t=i.compute(e);return i.sort?t.sort(i.sort):t},onadd:(e,t,s)=>i.onadd?i.onadd(e,t,s):(N(t,i.matches)&&(e.push(t),i.sort&&e.sort(i.sort)),e),onremove:(e,t,s)=>{if(i.onremove)return i.onremove(e,t,s);if(N(t,i.matches)){const a=e.findIndex(d=>d.id===t.id);a!==-1&&e.splice(a,1)}return e}}),N=(i,e)=>!e||e(i),ee=(i,e,t,s)=>{if(e===void 0)return;let a=i.get(e);if(!a){const d=I([]);i.set(e,a=d)}a.push(t),s&&a.sort(s)},$t=(i,e,t)=>{if(e===void 0)return;const s=i.get(e);if(!s)return;const a=s.findIndex(d=>d.id===t.id);a!==-1&&(s.length===1?i.delete(e):s.splice(a,1))},hi=b.extend({items:h(Ut).default(()=>[])}).meta({cell_class_name:"Models"});class Ft extends f{items=new z({indexes:[H({key:"name",extractor:e=>e.name,query_schema:_()}),K({key:"provider_name",extractor:e=>e.provider_name,query_schema:_()}),K({key:"tag",extractor:e=>e.tags,query_schema:_(),matches:e=>e.tags.length>0}),Q({key:"ordered_by_name",compute:e=>e.values,sort:(e,t)=>e.name.localeCompare(t.name)})]});#e=l(()=>this.items.derived_index("ordered_by_name"));get ordered_by_name(){return r(this.#e)}set ordered_by_name(e){n(this.#e,e)}constructor(e){super(hi,e),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}add(e){const t=new re({app:this.app,json:e});this.items.add(t)}add_many(e){const t=e.map(s=>new re({app:this.app,json:s}));this.items.add_many(t)}find_by_name(e){return this.items.by_optional("name",e)}filter_by_names(e){let t;for(const s of e){const a=this.items.by_optional("name",s);a&&(t??=[]).push(a)}return t}filter_by_tag(e){return this.items.where("tag",e)}remove_by_name(e){const t=this.items.by_optional("name",e);t&&this.items.remove(t.id)}clear(){this.items.clear()}}const Wt=i=>{if(!i)return null;const{data:e}=i;switch(e.type){case"ollama":return e.value?.message?.content||null;case"claude":return e.value?.content?.[0]?.text||null;case"chatgpt":return e.value?.choices?.[0]?.message?.content||null;case"gemini":return e.value.text||null;default:return console.error("unknown provider type",e),null}},Vt=_(),Ht=m({role:Vt,content:_()}),he=c({created:Je,provider_name:X,model:_(),prompt:_(),completion_messages:h(Ht).optional()}),Yt=c({created:Je,provider_name:X,model:_(),data:Qs}),Gt=b.extend({part_ids:h(w).default(()=>[]),thread_id:w.nullable().optional(),role:Vt,request:he.optional(),response:Yt.optional(),error_message:_().optional()}).meta({cell_class_name:"Turn"});A(f);class We extends f{#e=o();get part_ids(){return r(this.#e)}set part_ids(e){n(this.#e,e,!0)}#t=o();get thread_id(){return r(this.#t)}set thread_id(e){n(this.#t,e,!0)}#s=o();get role(){return r(this.#s)}set role(e){n(this.#s,e,!0)}#i=o();get request(){return r(this.#i)}set request(e){n(this.#i,e)}#r=o();get response(){return r(this.#r)}set response(e){n(this.#r,e)}#n=o();get error_message(){return r(this.#n)}set error_message(e){n(this.#n,e,!0)}#a=l(()=>this.part_ids.map(e=>this.app.parts.items.by_id.get(e)).filter(e=>!!e));get parts(){return r(this.#a)}set parts(e){n(this.#a,e)}get enabled(){return this.parts.length>0&&this.parts.every(e=>e.enabled)}set enabled(e){for(const t of this.parts)t.enabled=e}get content(){return this.parts.map(e=>e.content).filter(e=>e!=null).join(`

`)}set content(e){e!=null&&this.parts[0]&&(this.parts[0].content=e)}#o=l(()=>this.content.length);get length(){return r(this.#o)}set length(e){n(this.#o,e)}#l=l(()=>G(this.content));get token_count(){return r(this.#l)}set token_count(e){n(this.#l,e)}#_=l(()=>this.parts[0]?.content);get raw_content(){return r(this.#_)}set raw_content(e){n(this.#_,e)}#d=l(()=>this.parts.length>0&&this.parts.every(e=>e.content!==void 0));get is_content_loaded(){return r(this.#d)}set is_content_loaded(e){n(this.#d,e)}#c=l(()=>this.parts.length===0||this.parts.every(e=>!e.content));get is_content_empty(){return r(this.#c)}set is_content_empty(e){n(this.#c,e)}#h=l(()=>this.role==="assistant"&&this.is_content_loaded&&this.is_content_empty&&!this.response&&!this.error_message);get pending(){return r(this.#h)}set pending(e){n(this.#h,e)}constructor(e){super(Gt,e),this.init()}set_part(e){this.part_ids=[e.id]}add_part(e){this.part_ids.includes(e.id)||this.part_ids.push(e.id)}remove_part(e){const t=this.part_ids.indexOf(e);return t!==-1?(this.part_ids.splice(t,1),!0):!1}}const ui=(i,e,t)=>new We({app:i.app,json:{...t,role:e,part_ids:[i.id]}}),Ee=(i,e,t,s)=>{const a=s.parts.add({type:"text",content:i});return new We({app:s,json:{...t,role:e,part_ids:[a.id]}})},Xt=b.extend({model_name:C.default(""),turns:h(Gt).default(()=>[]),enabled:v().default(!0)}).meta({cell_class_name:"Thread"}),Re=(i,e,t="message")=>`<${t} role="${i}">${e}</${t}>`,pi=(i,e="message")=>{let t="";for(const s of i)s.enabled!==!1&&(t&&(t+=`

`),t+=Re(s.role,s.content,e));return t},mi=(i,e=[])=>{for(const t of i)t.enabled&&e.push({role:t.role,content:t.role==="assistant"&&t.response?Wt(t.response)||"":t.content});return e};class ne extends f{#e=o();get model_name(){return r(this.#e)}set model_name(e){n(this.#e,e,!0)}#t=l(()=>{const e=this.app.models.find_by_name(this.model_name);if(!e)throw new Error(`Model "${this.model_name}" not found`);return e});get model(){return r(this.#t)}set model(e){n(this.#t,e)}turns=new z;#s=o();get enabled(){return r(this.#s)}set enabled(e){n(this.#s,e,!0)}#i=l(()=>pi(this.turns.by_id.values()));get content(){return r(this.#i)}set content(e){n(this.#i,e)}#r=l(()=>this.content.length);get length(){return r(this.#r)}set length(e){n(this.#r,e)}#n=l(()=>G(this.content));get token_count(){return r(this.#n)}set token_count(e){n(this.#n,e)}#a=l(()=>Ce(this.content));get content_preview(){return r(this.#a)}set content_preview(e){n(this.#a,e)}constructor(e){super(Xt,e),this.decoders={turns:t=>{if(Array.isArray(t)){this.turns.clear();for(const s of t)this.add_turn(s)}return j}},this.init()}add_turn(e){e.thread_id=this.id,this.turns.add(e)}add_user_turn(e,t){const s=Ee(e,"user",{thread_id:this.id,request:t},this.app);return this.add_turn(s),s}add_assistant_turn(e,t){const s=Ee(e,"assistant",{...t,thread_id:this.id},this.app);return this.add_turn(s),s}add_system_turn(e){const t=Ee(e,"system",{thread_id:this.id},this.app);return this.add_turn(t),t}add_turn_from_part(e,t){const s=ui(e,t,{thread_id:this.id});return this.add_turn(s),s}remove_all_turns(){this.turns.clear()}async send_message(e){const t=this.app.lookup_provider_status(this.model.provider_name);if(t&&!t.available)return console.warn(`[thread.send_message] provider '${this.model.provider_name}' unavailable, skipping send`),null;const s=mi(this.turns.by_id.values()),a=this.add_user_turn(e),d=he.parse({created:a.created,provider_name:this.model.provider_name,model:this.model.name,prompt:e,completion_messages:s}),u=this.add_assistant_turn("",{request:d});return a.request=d,await this.app.api.completion_create({completion_request:d,_meta:{progressToken:u.id}}),u}switch_model(e){const t=this.app.models.items.by_id.get(e);t?this.model_name=t.name:console.error(`model with id ${e} not found`)}}const Bt=(i,e,t)=>{if(e===t)return;if(e<0||t<0||e>=i.length||t>i.length){console.error(`Invalid indices: from ${e} to ${t} in array of length ${i.length}`);return}const[s]=i.splice(e,1);i.splice(t,0,s)},ue=(i,e,t)=>{if(e===t)return i;if(e<0||t<0||e>=i.length||t>i.length)return console.error(`Invalid indices: from ${e} to ${t} in array of length ${i.length}`),i;const s=i[e];return e<t?[...i.slice(0,e),...i.slice(e+1,t+1),s,...i.slice(t+1)]:[...i.slice(0,t),s,...i.slice(t,e),...i.slice(e+1)]},fi=q(["simple","multi"]).default("simple"),Kt=b.extend({name:_().default(""),thread_ids:h(w).default(()=>[]),main_input:_().default(""),view_mode:fi,selected_thread_id:w.nullable().default(null)}).meta({cell_class_name:"Chat"});class ae extends f{#e=o();get name(){return r(this.#e)}set name(e){n(this.#e,e,!0)}#t=o();get thread_ids(){return r(this.#t)}set thread_ids(e){n(this.#t,e,!0)}#s=o();get main_input(){return r(this.#s)}set main_input(e){n(this.#s,e,!0)}#i=o();get view_mode(){return r(this.#i)}set view_mode(e){n(this.#i,e,!0)}#r=o();get selected_thread_id(){return r(this.#r)}set selected_thread_id(e){n(this.#r,e,!0)}#n=l(()=>this.main_input.length);get main_input_length(){return r(this.#n)}set main_input_length(e){n(this.#n,e)}#a=l(()=>G(this.main_input));get main_input_token_count(){return r(this.#a)}set main_input_token_count(e){n(this.#a,e)}#o=l(()=>{const e=[],{by_id:t}=this.app.threads.items;for(const s of this.thread_ids){const a=t.get(s);a&&e.push(a)}return e});get threads(){return r(this.#o)}set threads(e){n(this.#o,e)}#l=l(()=>this.threads.filter(e=>e.enabled));get enabled_threads(){return r(this.#l)}set enabled_threads(e){n(this.#l,e)}#_=l(()=>this.selected_thread_id?this.app.threads.items.by_id.get(this.selected_thread_id):void 0);get selected_thread(){return r(this.#_)}set selected_thread(e){n(this.#_,e)}#d=l(()=>this.selected_thread||this.enabled_threads[0]);get current_thread(){return r(this.#d)}set current_thread(e){n(this.#d,e)}#c=o("initial");get init_name_status(){return r(this.#c)}set init_name_status(e){n(this.#c,e,!0)}constructor(e){super(Kt,e),this.init()}add_thread(e,t){const s=new ne({app:this.app,json:{model_name:e.name}});this.app.threads.add_thread(s),this.thread_ids.push(s.id),(t||!this.selected_thread_id&&this.thread_ids.length===1)&&this.select_thread(s.id)}add_threads_by_model_tag(e){const t=this.app.models.filter_by_tag(e);for(const s of t)this.add_thread(s)}remove_thread(e){const t=this.thread_ids.findIndex(s=>s===e);t!==-1&&this.thread_ids.splice(t,1)}remove_threads(e){this.thread_ids=this.thread_ids.filter(t=>!e.includes(t))}remove_threads_by_model_tag(e){for(const t of this.threads.filter(s=>s.model.tags.includes(e)))this.remove_thread(t.id)}remove_all_threads(){this.thread_ids.length=0}async send_to_all(e){await Promise.all(this.enabled_threads.map(t=>this.send_to_thread(t.id,e)))}async send_to_thread(e,t){const s=this.app.threads.items.by_id.get(e);if(!s)return;this.updated=de();const a=await s.send_message(t);a&&this.init_name_from_turns(t,a.content)}async init_name_from_turns(e,t){if(this.init_name_status!=="initial")return;const s=this.app.models.find_by_name(this.app.bots.namerbot);if(!s){console.warn(`[chat.init_name_from_turns] namerbot model not found: ${this.app.bots.namerbot}`);return}const a=this.app.lookup_provider_status(s.provider_name);if(a&&!a.available){console.warn(`[chat.init_name_from_turns] namerbot provider '${s.provider_name}' unavailable, skipping auto-naming`);return}this.init_name_status="pending";let d=`Output a short title for this chat conversation with no commentary,
			for this chat content, use lowercase words (unless proper nouns) with no punctuation:

`;d+=Re("user",e),d+=`

`+Re("assistant",t);try{const u=await this.app.api.completion_create({completion_request:he.parse({provider_name:s.provider_name,model:this.app.bots.namerbot,prompt:d})});if(!u.ok){this.init_name_status="initial",console.error("failed to infer a name for a chat",u.error);return}const{completion_response:S}=u.value,ke=Wt(S)||"";if(!ke){console.error("unknown inference failure",u),this.init_name_status="initial";return}this.init_name_status="success",ke!==this.name&&(this.name=ce(ke,this.app.chats.items_by_name))}catch(u){this.init_name_status="initial",console.error("failed to infer a name for a chat",u)}}select_thread(e){this.selected_thread_id=e}reorder_threads(e,t){Bt(this.thread_ids,e,t)}}A(ae);const gi=i=>i?W(`/chats/${i}`):W("/chats"),vi=i=>i?W(`/prompts/${i}`):W("/prompts"),nn="You are a helpful assistant that responds succinctly unless asked for more.",an=1e3,on=void 0,ln=void 0,_n=void 0,dn=void 0,cn=void 0,hn=void 0,un=void 0,bi={namerbot:"gemma3:1b"},pn=[{name:"ollama",title:"Ollama",url:"https://github.com/ollama/ollama/tree/main/docs",homepage:"https://ollama.com/",company:"Ollama",api_key_url:null},{name:"claude",title:"Claude",url:"https://docs.anthropic.com/en/home",homepage:"https://claude.ai/",company:"Anthropic",api_key_url:"https://console.anthropic.com/settings/keys"},{name:"chatgpt",title:"ChatGPT",url:"https://platform.openai.com/docs/overview",homepage:"https://chatgpt.com/",company:"OpenAI",api_key_url:"https://platform.openai.com/api-keys"},{name:"gemini",title:"Gemini",url:"https://ai.google.dev/gemini-api/docs/",homepage:"https://gemini.google.com/",company:"Google",api_key_url:"https://aistudio.google.com/app/api-keys"}],mn=[{name:"gemma3n:e2b",provider_name:"ollama",tags:["small"]},{name:"gemma3n:e4b",provider_name:"ollama",tags:["small"]},{name:"gemma3:1b",provider_name:"ollama",tags:["small"]},{name:"gemma3:4b",provider_name:"ollama",tags:["small"]},{name:"qwen3:0.6b",provider_name:"ollama",tags:["small"]},{name:"qwen3:1.7b",provider_name:"ollama",tags:["small"]},{name:"qwen3:4b",provider_name:"ollama",tags:[]},{name:"qwen3:8b",provider_name:"ollama",tags:[]},{name:"deepseek-r1:1.5b",provider_name:"ollama",tags:["small","reasoning"]},{name:"deepseek-r1:7b",provider_name:"ollama",tags:["reasoning"]},{name:"deepseek-r1:8b",provider_name:"ollama",tags:["reasoning"]},{name:"llama3.2:1b",provider_name:"ollama",tags:["small"]},{name:"llama3.2:3b",provider_name:"ollama",tags:["small"]},{name:"phi4-mini:3.8b",provider_name:"ollama",tags:[]},{name:"smollm2:135m",provider_name:"ollama",tags:["small"]},{name:"smollm2:360m",provider_name:"ollama",tags:["small"]},{name:"smollm2:1.7b",provider_name:"ollama",tags:["small"]},{name:"claude-sonnet-4-5-20250929",provider_name:"claude",tags:["smart"]},{name:"claude-opus-4-1-20250805",provider_name:"claude",tags:["smart","smartest"]},{name:"claude-3-5-haiku-20241022",provider_name:"claude",tags:["cheap"]},{name:"gpt-5-2025-08-07",provider_name:"chatgpt",tags:["smart"]},{name:"gpt-5-nano-2025-08-07",provider_name:"chatgpt",tags:["cheap","cheaper"]},{name:"gpt-5-mini-2025-08-07",provider_name:"chatgpt",tags:["cheap"]},{name:"gpt-4.1-2025-04-14",provider_name:"chatgpt",tags:["smart"]},{name:"gemini-2.5-pro",provider_name:"gemini",tags:["smart"]},{name:"gemini-2.5-flash",provider_name:"gemini",tags:["cheap"]},{name:"gemini-2.5-flash-lite",provider_name:"gemini",tags:["cheap","cheaper"]}],yi=[{id:E(),name:"frontier",model_names:["claude-sonnet-4-5-20250929","gpt-5-2025-08-07","gemini-2.5-pro"]},{id:E(),name:"cheap frontier",model_names:["claude-3-5-haiku-20241022","gpt-5-nano-2025-08-07","gemini-2.5-flash-lite"]},{id:E(),name:"local 3-4b",model_names:["gemma3n:e4b","gemma3:4b","llama3.2:3b","phi4-mini:3.8b","qwen3:4b"]},{id:E(),name:"local 1-2b",model_names:["gemma3n:e2b","gemma3:1b","llama3.2:1b","qwen3:1.7b","deepseek-r1:1.5b","smollm2:1.7b"]},{id:E(),name:"local <1b",model_names:["qwen3:0.6b","smollm2:135m","smollm2:360m"]},{id:E(),name:"local gemmas",model_names:["gemma3:1b","gemma3n:e2b","gemma3n:e4b","gemma3:4b"]},{id:E(),name:"quick test",model_names:["gemma3:1b","claude-3-5-haiku-20241022","gpt-5-nano-2025-08-07","gemini-2.5-flash-lite"]}],wi=b.extend({items:h(Kt).default(()=>[]),selected_id:_().nullable().default(null),selected_id_last_non_null:_().nullable().default(null),show_sort_controls:v().default(!1)}).meta({cell_class_name:"Chats"});class Ve extends f{items=new z({indexes:[H({key:"by_name",extractor:e=>e.name,query_schema:_()}),Q({key:"manual_order",compute:e=>e.values})]});#e=o();#t=o();get selected_id_last_non_null(){return r(this.#t)}set selected_id_last_non_null(e){n(this.#t,e,!0)}get selected_id(){return r(this.#e)}set selected_id(e){n(this.#e,e,!0),e!==null&&(this.selected_id_last_non_null=e)}#s=l(()=>r(this.#e)?this.items.by_id.get(r(this.#e)):void 0);get selected(){return r(this.#s)}set selected(e){n(this.#s,e)}#i=l(()=>r(this.#e)!==null&&this.selected===void 0);get selected_id_error(){return r(this.#i)}set selected_id_error(e){n(this.#i,e)}#r=o();get show_sort_controls(){return r(this.#r)}set show_sort_controls(e){n(this.#r,e,!0)}#n=l(()=>this.items.derived_index("manual_order"));get ordered_items(){return r(this.#n)}set ordered_items(e){n(this.#n,e)}#a=l(()=>this.items.single_index("by_name"));get items_by_name(){return r(this.#a)}set items_by_name(e){n(this.#a,e)}constructor(e){super(wi,e),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}add(e,t){const s=e?.name?e:{...e,name:this.generate_unique_name("new chat")},a=new ae({app:this.app,json:s});return this.add_chat(a,t)}generate_unique_name(e="new chat"){return ce(e,this.items_by_name)}add_chat(e,t){return this.items.add(e),t&&this.select(e.id),e}add_many(e,t){const s=e.map(a=>new ae({app:this.app,json:a}));return this.items.add_many(s),(t===!0||typeof t=="number"||r(this.#e)===null&&s.length>0)&&this.select(s[typeof t=="number"?t:0].id),s}remove(e){this.items.remove(e)&&e===r(this.#e)&&this.select_next()}remove_many(e){const t=this.items.remove_many(e);return r(this.#e)!==null&&e.includes(r(this.#e))&&this.select_next(),t}select(e){return this.navigate_to(e)}select_next(){const{by_id:e}=this.items,t=e.values().next();return this.navigate_to(t.value?.id??null)}async navigate_to(e,t=!1){const s=gi(e);if(this.app.ui.pending_element_to_focus_key=e,!(!t&&Me.url.pathname===s))return ie(s)}reorder_chats(e,t){this.items.indexes.manual_order=ue(this.ordered_items,e,t)}toggle_sort_controls(e=!this.show_sort_controls){this.show_sort_controls=e}#o=o(yi);get chat_templates(){return r(this.#o)}set chat_templates(e){n(this.#o,e)}get_template_by_id(e){return this.chat_templates.find(t=>t.id===e)}get_default_template(){return this.chat_templates[0]}}A(Ve);const ki=b.extend({items:h(Xt).default(()=>[]),selected_id:_().nullable().default(null)}).meta({cell_class_name:"Threads"});class Qt extends f{items=new z({indexes:[K({key:"by_model_name",extractor:e=>e.model_name,query_schema:C}),Q({key:"manual_order",compute:e=>e.values})]});#e=o(null);get selected_id(){return r(this.#e)}set selected_id(e){n(this.#e,e,!0)}#t=l(()=>this.selected_id?this.items.by_id.get(this.selected_id):void 0);get selected(){return r(this.#t)}set selected(e){n(this.#t,e)}#s=l(()=>this.selected_id!==null&&this.selected===void 0);get selected_id_error(){return r(this.#s)}set selected_id_error(e){n(this.#s,e)}#i=l(()=>this.items.derived_index("manual_order"));get ordered_items(){return r(this.#i)}set ordered_items(e){n(this.#i,e)}constructor(e){super(ki,e),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}add(e,t){const s=new ne({app:this.app,json:e});return this.add_thread(s,t)}add_thread(e,t){return this.items.add(e),(t||this.selected_id===null)&&(this.selected_id=e.id),e}add_many(e,t){const s=e.map(a=>new ne({app:this.app,json:a}));return this.items.add_many(s),(t===!0||typeof t=="number"||this.selected_id===null&&s.length>0)&&(this.selected_id=s[typeof t=="number"?t:0].id),s}remove(e){this.#r(e),this.items.remove(e)&&e===this.selected_id&&this.select_next()}remove_many(e){this.#n(e);const t=this.selected_id,s=this.items.remove_many(e);return t!==null&&e.includes(t)&&this.select_next(),s}#r(e){for(const t of this.app.chats.items.by_id.values())t.remove_thread(e)}#n(e){if(e.length===1){this.#r(e[0]);return}for(const t of this.app.chats.items.by_id.values())t.remove_threads(e)}select(e){this.selected_id=e}select_next(){const{by_id:e}=this.items,t=e.values().next();this.select(t.value?.id??null)}reorder_threads(e,t){this.items.indexes.manual_order=ue(this.ordered_items,e,t)}}const xi=b.extend({items:h(Ct).default(()=>[])}).meta({cell_class_name:"Providers"});class Zt extends f{#e=o();get items(){return r(this.#e)}set items(e){n(this.#e,e,!0)}#t=l(()=>this.items.map(e=>e.name));get names(){return r(this.#t)}set names(e){n(this.#t,e)}constructor(e){super(xi,e),this.init()}add(e){this.items.push(e)}find_by_name(e){return this.items.find(t=>t.name===e)}remove_by_name(e){const t=this.items.findIndex(s=>s.name===e);t!==-1&&this.items.splice(t,1)}clear(){this.items.length=0}}const qi=i=>i[0]==="/",Ei=(i,e)=>Oe(Oe(i,e),"/"),Te=(i,e=E())=>{const t=Je.parse(i.ctime==null?void 0:new Date(i.ctime).toISOString());return{id:e,source_dir:i.source_dir,path:i.id,content:i.contents,created:t,updated:i.mtime==null?t:zs.parse(new Date(i.mtime).toISOString()),dependents:i.dependents,dependencies:i.dependencies}},Ti=/\.[mc]?[jt]sx?$/i,fn=i=>i.dependencies_count>0||i.dependents_count>0||Ti.test(i.path),Di=q(["add","change","delete"]),x=_().refine(i=>qi(i),{message:"path must be absolute"}).brand("Diskfile_Path"),pe=Ns.pipe(x).brand("Diskfile_Directory_Path"),Ai=c({type:Di,path:x}),oe=c({id:x,source_dir:pe,contents:_().nullable(),ctime:g().nullable(),mtime:g().nullable(),dependents:h(te([x,O()])),dependencies:h(te([x,O()]))}),es=b.extend({path:x.nullable().default(null),source_dir:pe,content:_().nullable().default(null),dependents:h(te([x,oe])).nullable().default(null),dependencies:h(te([x,oe])).nullable().default(null)}).meta({cell_class_name:"Diskfile"});class He extends f{#e=o();get path(){return r(this.#e)}set path(e){n(this.#e,e,!0)}#t=o();get source_dir(){return r(this.#t)}set source_dir(e){n(this.#t,e,!0)}#s=o();get content(){return r(this.#s)}set content(e){n(this.#s,e,!0)}#i=l(()=>this.app.parts.find_part_by_diskfile_path(this.path));get part(){return r(this.#i)}set part(e){n(this.#i,e)}#r=o();get dependents(){return r(this.#r)}set dependents(e){n(this.#r,e,!0)}#n=o();get dependencies(){return r(this.#n)}set dependencies(e){n(this.#n,e,!0)}#a=l(()=>new Map(this.dependencies));get dependencies_by_id(){return r(this.#a)}set dependencies_by_id(e){n(this.#a,e)}#o=l(()=>new Map(this.dependents));get dependents_by_id(){return r(this.#o)}set dependents_by_id(e){n(this.#o,e)}#l=l(()=>this.dependencies.map(([e])=>e));get dependency_ids(){return r(this.#l)}set dependency_ids(e){n(this.#l,e)}#_=l(()=>this.dependents.map(([e])=>e));get dependent_ids(){return r(this.#_)}set dependent_ids(e){n(this.#_,e)}#d=l(()=>this.dependencies.length>0);get has_dependencies(){return r(this.#d)}set has_dependencies(e){n(this.#d,e)}#c=l(()=>this.dependents.length>0);get has_dependents(){return r(this.#c)}set has_dependents(e){n(this.#c,e)}#h=l(()=>this.dependencies.length);get dependencies_count(){return r(this.#h)}set dependencies_count(e){n(this.#h,e)}#u=l(()=>this.dependents.length);get dependents_count(){return r(this.#u)}set dependents_count(e){n(this.#u,e)}#p=l(()=>this.path&&this.app.zzz_cache_dir&&Oe(this.path,this.app.zzz_cache_dir));get pathname(){return r(this.#p)}set pathname(e){n(this.#p,e)}#m=l(()=>this.app.diskfiles.to_relative_path(this.path));get path_relative(){return r(this.#m)}set path_relative(e){n(this.#m,e)}#f=l(()=>this.content?.length??0);get content_length(){return r(this.#f)}set content_length(e){n(this.#f,e)}#v=l(()=>this.content===null?null:G(this.content));get content_token_count(){return r(this.#v)}set content_token_count(e){n(this.#v,e)}#g=l(()=>Ce(this.content));get content_preview(){return r(this.#g)}set content_preview(e){n(this.#g,e)}constructor(e){super(es,e),this.init()}}A(He);const Oi=b.extend({diskfile_id:w}).meta({cell_class_name:"Diskfile_Tab"});class Ye extends f{#e=o();get diskfile_id(){return r(this.#e)}set diskfile_id(e){n(this.#e,e,!0)}tabs;#t=l(()=>this.tabs.preview_tab_id===this.id);get is_preview(){return r(this.#t)}set is_preview(e){n(this.#t,e)}#s=l(()=>this.tabs.selected_tab_id===this.id);get is_selected(){return r(this.#s)}set is_selected(e){n(this.#s,e)}#i=l(()=>this.app.diskfiles.items.by_id.get(this.diskfile_id));get diskfile(){return r(this.#i)}set diskfile(e){n(this.#i,e)}constructor(e){super(Oi,e),this.tabs=e.tabs,this.init()}}A(Ye);const ts=(i,e)=>{const t=new Map;for(const s of i)t.set(s[e],s);return t},Ri=b.extend({selected_tab_id:w.nullable().default(null),preview_tab_id:w.nullable().default(null),tab_order:h(w).default(()=>[]),recent_tab_ids:h(w).default(()=>[]),max_tab_history:g().default(20)}).meta({cell_class_name:"Diskfile_Tabs"});class Ge extends f{#e=o();get selected_tab_id(){return r(this.#e)}set selected_tab_id(e){n(this.#e,e,!0)}#t=o();get preview_tab_id(){return r(this.#t)}set preview_tab_id(e){n(this.#t,e,!0)}#s=o();get tab_order(){return r(this.#s)}set tab_order(e){n(this.#s,e,!0)}#i=o();get recent_tab_ids(){return r(this.#i)}set recent_tab_ids(e){n(this.#i,e,!0)}#r=o();get max_tab_history(){return r(this.#r)}set max_tab_history(e){n(this.#r,e,!0)}items=new z;#n=l(()=>ts(this.items.by_id.values(),"diskfile_id"));get by_diskfile_id(){return r(this.#n)}set by_diskfile_id(e){n(this.#n,e)}#a=l(()=>{const{by_id:e}=this.items,t=[],s=new Set;for(const a of this.tab_order){const d=e.get(a);d&&(t.push(d),s.add(a))}for(const a of e.values())s.has(a.id)||t.push(a);return t});get ordered_tabs(){return r(this.#a)}set ordered_tabs(e){n(this.#a,e)}#o=l(()=>this.selected_tab_id?this.items.by_id.get(this.selected_tab_id):void 0);get selected_tab(){return r(this.#o)}set selected_tab(e){n(this.#o,e)}#l=l(()=>this.selected_tab?.diskfile_id??null);get selected_diskfile_id(){return r(this.#l)}set selected_diskfile_id(e){n(this.#l,e)}#_=l(()=>this.preview_tab_id?this.items.by_id.get(this.preview_tab_id):void 0);get preview_tab(){return r(this.#_)}set preview_tab(e){n(this.#_,e)}#d=l(()=>{const e=[];for(const t of this.recent_tab_ids){const s=this.items.by_id.get(t);s&&e.push(s)}return e});get recent_tabs(){return r(this.#d)}set recent_tabs(e){n(this.#d,e)}#c=o(I([]));get recently_closed_tabs(){return r(this.#c)}set recently_closed_tabs(e){n(this.#c,e,!0)}closed_tab_diskfiles=new L;constructor(e){super(Ri,e),this.init()}#h(e){const t=this.items.by_id.get(e);if(!t)return;const s=this.recent_tab_ids.filter(a=>a!==e);s.unshift(t.id),s.length>this.max_tab_history&&(s.length=this.max_tab_history),this.recent_tab_ids=s}find_most_recent_tab(e){for(const t of this.recent_tabs)if(t.id!==e&&this.items.by_id.has(t.id))return t.id;return null}select_tab(e){console.log("Diskfile_Tabs.select_tab",{tab_id:e}),this.selected_tab_id=e,this.#h(e)}#u(e,t){const s=this.tab_order.indexOf(e);if(s!==-1&&this.tab_order.splice(s,1),t!=null){const a=this.tab_order.indexOf(t);if(a!==-1){this.tab_order.splice(a+1,0,e);return}}this.tab_order.push(e)}#p(e,t){const s=new Ye({app:this.app,tabs:this,json:{id:E(),diskfile_id:e}});return this.items.add(s),this.#u(s.id,t),s}#m(e,t){const s=this.by_diskfile_id.get(e);if(s)return t==="permanent"&&s.id===this.preview_tab_id&&(this.preview_tab_id=null),{tab:s,is_new:!1};if(this.preview_tab){const d=this.preview_tab;return t==="permanent"&&(this.preview_tab_id=null),d.diskfile_id=e,{tab:d,is_new:!1}}const a=this.#p(e,this.selected_tab_id);return t==="preview"&&(this.preview_tab_id=a.id),{tab:a,is_new:!0}}preview_diskfile(e){console.log("Diskfile_Tabs.preview_diskfile",{diskfile_id:e});const t=this.selected_tab_id,s=this.preview_tab?.diskfile_id,{tab:a,is_new:d}=this.#m(e,"preview");return this.selected_tab_id=a.id,this.#h(a.id),!d&&a.id===this.preview_tab_id&&s!==e&&t&&t!==a.id&&this.#u(a.id,t),a}open_diskfile(e){console.log("Diskfile_Tabs.open_diskfile",{diskfile_id:e});const{tab:t}=this.#m(e,"permanent");return this.selected_tab_id=t.id,this.#h(t.id),t}promote_preview_to_permanent(){return console.log("Diskfile_Tabs.promote_preview_to_permanent"),this.preview_tab_id?(this.preview_tab_id=null,!0):!1}close_tab(e){console.log("Diskfile_Tabs.close_tab",{tab_id:e});const t=this.items.by_id.get(e);if(!t)return;this.closed_tab_diskfiles.set(e,t.diskfile_id);const s=e===this.selected_tab_id,a=e===this.preview_tab_id;if(s){const d=this.find_most_recent_tab(e);if(d)this.selected_tab_id=d;else{const u=this.tab_order.indexOf(e);u!==-1&&u<this.tab_order.length-1?this.selected_tab_id=this.tab_order[u+1]:u>0?this.selected_tab_id=this.tab_order[u-1]:this.selected_tab_id=null}}this.recently_closed_tabs.push(t),this.tab_order=this.tab_order.filter(d=>d!==e),this.items.remove(e),this.recent_tab_ids=this.recent_tab_ids.filter(d=>d!==e),a&&(this.preview_tab_id=null)}navigate_to_tab(e){if(console.log("Diskfile_Tabs.navigate_to_tab",{tab_id:e}),this.items.by_id.has(e))return this.select_tab(e),{resulting_tab_id:e,created_preview:!1};const t=this.closed_tab_diskfiles.get(e);return t?{resulting_tab_id:this.preview_diskfile(t).id,created_preview:!0}:{resulting_tab_id:null,created_preview:!1}}open_tab(e){console.log("Diskfile_Tabs.open_tab",{tab_id:e}),e===this.preview_tab_id&&(this.preview_tab_id=null)}reorder_tabs(e,t){console.log("Diskfile_Tabs.reorder_tabs",{from_index:e,to_index:t}),this.tab_order=ue(this.tab_order,e,t)}reopen_last_closed_tab(){if(console.log("Diskfile_Tabs.reopen_last_closed_tab"),this.recently_closed_tabs.length>0){const e=this.recently_closed_tabs.pop();if(e){const t=this.#p(e.diskfile_id);this.selected_tab_id=t.id,this.#h(t.id)}}}close_all_tabs(){console.log("Diskfile_Tabs.close_all_tabs");for(const e of this.ordered_tabs)this.closed_tab_diskfiles.set(e.id,e.diskfile_id);this.recently_closed_tabs=[...this.ordered_tabs],this.selected_tab_id=null,this.preview_tab_id=null,this.tab_order=[],this.recent_tab_ids=[],this.items.clear()}}A(Ge);const Si=b.extend({show_sort_controls:v().default(!1)}).meta({cell_class_name:"Diskfiles_Editor"});class Xe extends f{#e=o(!1);get show_sort_controls(){return r(this.#e)}set show_sort_controls(e){n(this.#e,e,!0)}tabs=new Ge({app:this.app});constructor(e){super(Si,e),this.init()}preview_diskfile(e){console.log("Diskfiles_Editor.preview_diskfile",{diskfile_id:e}),this.tabs.preview_diskfile(e)}open_diskfile(e){console.log("Diskfiles_Editor.open_diskfile",{diskfile_id:e}),this.tabs.open_diskfile(e)}reorder_tabs(e,t){console.log("Diskfiles_Editor.reorder_tabs",{from_index:e,to_index:t}),this.tabs.reorder_tabs(e,t)}select_tab(e){console.log("Diskfiles_Editor.select_tab",{tab_id:e}),this.tabs.select_tab(e)}close_tab(e){console.log("Diskfiles_Editor.close_tab",{tab_id:e}),this.tabs.close_tab(e)}reopen_last_closed_tab(){console.log("Diskfiles_Editor.reopen_last_closed_tab"),this.tabs.reopen_last_closed_tab()}promote_preview_tab(){console.log("Diskfiles_Editor.promote_preview_tab"),this.tabs.promote_preview_to_permanent()}open_tab(e){console.log("Diskfiles_Editor.open_tab",{tab_id:e}),this.tabs.open_tab(e)}handle_file_modified(e){console.log("Diskfiles_Editor.handle_file_modified",{diskfile_id:e}),this.tabs.by_diskfile_id.get(e)?.id===this.tabs.preview_tab_id&&(this.tabs.preview_tab_id=null)}sync_selected_file(){console.log("Diskfiles_Editor.sync_selected_file");const e=this.tabs.selected_diskfile_id;e&&(this.app.diskfiles.selected_file_id=e)}toggle_sort_controls(e=!this.show_sort_controls){this.show_sort_controls=e}}A(Xe);const Pi=b.extend({diskfiles:h(es).default(()=>[]),selected_file_id:w.nullable().default(null)}).meta({cell_class_name:"Diskfiles"});class ss extends f{items=new z({indexes:[H({key:"by_path",extractor:e=>e.path,query_schema:_()}),K({key:"by_extension",extractor:e=>{const t=/\.([^.]+)$/.exec(e.path);return t?t[1].toLowerCase():"no_extension"},query_schema:_()})]});#e=o(null);get selected_file_id(){return r(this.#e)}set selected_file_id(e){n(this.#e,e,!0)}#t=l(()=>this.selected_file_id?this.items.by_id.get(this.selected_file_id)??null:null);get selected_file(){return r(this.#t)}set selected_file(e){n(this.#t,e)}editor;constructor(e){super(Pi,e),this.editor=new Xe({app:this.app}),this.decoders={diskfiles:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}handle_change(e){const t=e.disknode;switch(e.change.type){case"add":{this.add(Te(t));break}case"change":{const s=this.items.by_optional("by_path",t.id);if(s){const a=Te(t,s.id);s.set_json({...a,created:s.created,updated:de()})}else this.add(Te(t));break}case"delete":{const s=this.items.by_optional("by_path",t.id);s&&this.items.remove(s.id);break}}}add(e,t=!0){const s=new He({app:this.app,json:e});return this.items.add(s),t&&this.selected_file_id===null&&this.select(s.id),s}async update(e,t){(await this.app.api.diskfile_update({path:e,content:t})).ok}async delete(e){(await this.app.api.diskfile_delete({path:e})).ok}async create_file(e,t=""){if(!this.app.zzz_cache_dir)throw new Error("cannot create file: zzz_cache_dir is not set");const s=x.parse(`${this.app.zzz_cache_dir}${Js.parse(e)}`);await this.update(s,t)}async create_directory(e){if(!this.app.zzz_cache_dir)throw new Error("cannot create directory: zzz_cache_dir is not set");const t=x.parse(`${this.app.zzz_cache_dir}${e}`);(await this.app.api.directory_create({path:t})).ok}get_by_path(e){return this.items.by_optional("by_path",e)}to_relative_path(e){const{zzz_cache_dir:t}=this.app;return t&&Ei(e,t)}select(e,t=!1){e===void 0?this.select_next():(this.selected_file_id=e,e!==null&&(t?this.editor.open_diskfile(e):this.editor.preview_diskfile(e)))}select_next(){const{by_id:e}=this.items,t=e.values().next();this.select(t.value?.id??null)}}const Be=q(["completion_create","completion_progress","directory_create","diskfile_delete","diskfile_update","filer_change","ollama_copy","ollama_create","ollama_delete","ollama_list","ollama_progress","ollama_ps","ollama_pull","ollama_show","ollama_unload","ping","provider_load_status","provider_update_api_key","session_load","toggle_main_menu"]);q(["completion_create","directory_create","diskfile_delete","diskfile_update","ollama_copy","ollama_create","ollama_delete","ollama_list","ollama_ps","ollama_pull","ollama_show","ollama_unload","ping","provider_load_status","provider_update_api_key","session_load"]);q(["completion_progress","filer_change","ollama_progress"]);q(["toggle_main_menu"]);q(["completion_create","completion_progress","directory_create","diskfile_delete","diskfile_update","filer_change","ollama_copy","ollama_create","ollama_delete","ollama_list","ollama_progress","ollama_ps","ollama_pull","ollama_show","ollama_unload","ping","provider_load_status","provider_update_api_key","session_load","toggle_main_menu"]);q(["completion_create","completion_progress","directory_create","diskfile_delete","diskfile_update","filer_change","ollama_copy","ollama_create","ollama_delete","ollama_list","ollama_progress","ollama_ps","ollama_pull","ollama_show","ollama_unload","ping","provider_load_status","provider_update_api_key","session_load"]);/**
 * Following MCP, Zzz supports a subset of JSON-RPC 2.0 as its message format
 * (A2A too, but I haven't looked into if they support the full spec).
 * It can be used by multiple transports including http and websocket.
 *
 * These are the JSON-RPC types from the MCP draft in May 2025,
 * changed to include a prefix on all identifiers.
 * It's also defined with Zod schemas instead of plain TS like the MCP library.
 *
 * MCP messages are a subset of JSON-RPC:
 *
 * - `params` does not support the positional array format,
 * 		and `result` supports only `object` values, instead of being any JSON value.
 * - MCP does not support batching,
 * 		see https://github.com/modelcontextprotocol/modelcontextprotocol/pull/416
 * 		and https://github.com/modelcontextprotocol/modelcontextprotocol/pull/228
 *
 * @source https://github.com/modelcontextprotocol/typescript-sdk
 * @see https://modelcontextprotocol.io/
 * @license https://github.com/modelcontextprotocol/typescript-sdk/blob/main/LICENSE
 *
 * MIT License
 *
 * Copyright (c) 2024 Anthropic, PBC
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */const $="2.0",me=k([_(),g()]),is=_(),$i=k([_(),g()]),Ke=m({}),ji=Ke.extend({progressToken:$i.optional()}),rs=m({_meta:ji.optional()}),ns=m({_meta:Ke.optional()}),zi=k([rs,ns]),as=m({_meta:Ke.optional()}),fe=m({jsonrpc:y($),id:me,method:is,params:rs.optional()}),Z=m({jsonrpc:y($),method:is,params:ns.optional()}),ge=m({jsonrpc:y($),id:me,result:as}),os=-32700,ls=-32600,_s=-32601,ds=-32602,Qe=-32603,Ni=-32e3,Ji=-32099,Ci=g().gte(Ji).lte(Ni).brand("Jsonrpc_Server_Error_Code"),Mi=k([y(os),y(ls),y(_s),y(ds),y(Qe),Ci]),cs=m({code:Mi,message:_(),data:B().optional()}),ve=m({jsonrpc:y($),id:me.nullable(),error:cs}),Ii=k([ge,ve]);k([fe,Z,ge,ve]);k([fe,Z]);k([Z,ge,ve]);k([fe,Z,ge,ve]);const Li=q(["request_response","remote_notification","local_call"]),Ui=q(["frontend","backend"]);q(["frontend","backend","both"]);k([y("public"),y("authorize")]);k([y(!0),U()]);k([zi,Jt(),D()]);k([as,Jt(),D()]);const Ze={method:"ping",kind:"request_response",initiator:"both",auth:"public",side_effects:null,input:D().optional(),output:c({ping_id:me}),async:!0},et={method:"session_load",kind:"request_response",initiator:"frontend",auth:"public",side_effects:null,input:D().optional(),output:c({data:c({zzz_cache_dir:pe,files:h(oe),provider_status:h(Ue)})}),async:!0},tt={method:"filer_change",kind:"remote_notification",initiator:"backend",auth:null,side_effects:!0,input:c({change:Ai,disknode:oe}),output:D(),async:!0},st={method:"diskfile_update",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({path:x,content:_()}),output:U(),async:!0},it={method:"diskfile_delete",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({path:x}),output:U(),async:!0},rt={method:"directory_create",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({path:x}),output:U(),async:!0},nt={method:"completion_create",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({completion_request:he,_meta:m({progressToken:w.optional()}).optional()}),output:c({completion_response:Yt,_meta:m({progressToken:w.optional()}).optional()}),async:!0},at={method:"completion_progress",kind:"remote_notification",initiator:"backend",auth:null,side_effects:!0,input:c({chunk:m({model:_().optional(),created_at:_().optional(),done:v().optional(),message:Ht.optional()}).optional(),_meta:m({progressToken:w.optional()}).optional()}),output:D(),async:!0},ot={method:"ollama_progress",kind:"remote_notification",initiator:"backend",auth:null,side_effects:!0,input:c(ei.extend({_meta:m({progressToken:w.optional()}).optional()}).shape),output:D(),async:!0},lt={method:"toggle_main_menu",kind:"local_call",initiator:"frontend",auth:null,side_effects:!0,input:c({show:v().optional()}).optional(),output:c({show:v()}),async:!1},_t={method:"ollama_list",kind:"request_response",initiator:"frontend",auth:"public",side_effects:null,input:ri,output:k([ti,U()]),async:!0},dt={method:"ollama_ps",kind:"request_response",initiator:"frontend",auth:"public",side_effects:null,input:ni,output:k([ii,U()]),async:!0},ct={method:"ollama_show",kind:"request_response",initiator:"frontend",auth:"public",side_effects:null,input:ai,output:k([Lt,U()]),async:!0},ht={method:"ollama_pull",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c(oi.extend({_meta:m({progressToken:w.optional()}).optional()}).shape),output:D().optional(),async:!0},ut={method:"ollama_delete",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:_i,output:D().optional(),async:!0},pt={method:"ollama_copy",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:di,output:D().optional(),async:!0},mt={method:"ollama_create",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c(li.extend({_meta:m({progressToken:w.optional()}).optional()}).shape),output:D().optional(),async:!0},ft={method:"ollama_unload",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({model:_()}),output:D().optional(),async:!0},gt={method:"provider_load_status",kind:"request_response",initiator:"frontend",auth:"public",side_effects:null,input:c({provider_name:X,reload:v().default(!0).optional()}),output:c({status:Ue}),async:!0},vt={method:"provider_update_api_key",kind:"request_response",initiator:"frontend",auth:"public",side_effects:!0,input:c({provider_name:X,api_key:_()}),output:c({status:Ue}),async:!0};q(["completion_create","completion_progress","directory_create","diskfile_delete","diskfile_update","filer_change","ollama_copy","ollama_create","ollama_delete","ollama_list","ollama_progress","ollama_ps","ollama_pull","ollama_show","ollama_unload","ping","provider_load_status","provider_update_api_key","session_load","toggle_main_menu"]);const hs={completion_create:nt,completion_progress:at,directory_create:rt,diskfile_delete:it,diskfile_update:st,filer_change:tt,ollama_copy:pt,ollama_create:mt,ollama_delete:ut,ollama_list:_t,ollama_progress:ot,ollama_ps:dt,ollama_pull:ht,ollama_show:ct,ollama_unload:ft,ping:Ze,provider_load_status:gt,provider_update_api_key:vt,session_load:et,toggle_main_menu:lt},Fi=Object.values(hs),Wi={completion_create:nt.input,completion_progress:at.input,directory_create:rt.input,diskfile_delete:it.input,diskfile_update:st.input,filer_change:tt.input,ollama_copy:pt.input,ollama_create:mt.input,ollama_delete:ut.input,ollama_list:_t.input,ollama_progress:ot.input,ollama_ps:dt.input,ollama_pull:ht.input,ollama_show:ct.input,ollama_unload:ft.input,ping:Ze.input,provider_load_status:gt.input,provider_update_api_key:vt.input,session_load:et.input,toggle_main_menu:lt.input},Vi={completion_create:nt.output,completion_progress:at.output,directory_create:rt.output,diskfile_delete:it.output,diskfile_update:st.output,filer_change:tt.output,ollama_copy:pt.output,ollama_create:mt.output,ollama_delete:ut.output,ollama_list:_t.output,ollama_progress:ot.output,ollama_ps:dt.output,ollama_pull:ht.output,ollama_show:ct.output,ollama_unload:ft.output,ping:Ze.output,provider_load_status:gt.output,provider_update_api_key:vt.output,session_load:et.output,toggle_main_menu:lt.output},Hi=q(["initial","parsed","handling","handled","failed"]),Yi=q(["send_request","receive_request","send_response","receive_response","send_error","receive_error","send","receive","execute"]),Gi={initial:["parsed","failed"],parsed:["handling","failed"],handling:["handled","failed"],handled:[],failed:[]},Xi={request_response:["send_request","receive_request","send_response","receive_response","send_error","receive_error"],remote_notification:["send","receive"],local_call:["execute"]},us={send_request:"receive_response",receive_request:"send_response",send_response:null,receive_response:null,send_error:null,receive_error:null,send:null,receive:null,execute:null},Bi=c({kind:Li,phase:Yi,step:Hi,method:Be,executor:Ui,input:B().nullable(),output:B().nullable(),error:cs.nullable(),progress:B().nullable(),request:fe.nullable(),response:Ii.nullable(),notification:Z.nullable()}),jt=i=>i.kind==="request_response",ps=i=>i.kind==="request_response"&&i.phase==="send_request",ms=i=>i.kind==="remote_notification"&&i.phase==="send",Ki=i=>ps(i)&&(i.step==="parsed"||i.step==="handling"),Qi=i=>ms(i)&&(i.step==="parsed"||i.step==="handling"),Zi=(i,e)=>{if(!Gi[i].includes(e))throw new Error(`Invalid step transition from '${i}' to '${e}'`)},er=(i,e)=>{if(us[i]!==e)throw new Error(`Invalid phase transition from '${i}' to '${e}'`)},tr=(i,e,t)=>{if(e!=="both"&&e!==t)return null;switch(i){case"request_response":return"send_request";case"remote_notification":return"send";case"local_call":return"execute"}},sr=(i,e)=>i==="request_response"&&(e==="receive_request"||e==="receive_response")||i==="local_call"&&e==="execute",Se=i=>i.step==="failed"?!0:i.step!=="handled"?!1:us[i.phase]===null,fs=(i,e,t,s,a)=>({kind:i,phase:e,step:"initial",method:t,executor:s,input:a,output:null,error:null,progress:null,request:null,response:null,notification:null}),F=i=>{const{data:e}=i;if(e.step==="handled")return{ok:!0,value:e.output};if(e.step==="failed")return{ok:!1,error:e.error};throw new Error(`cannot extract result: event in non-terminal state (step: ${e.step})`)},gs=b.extend({method:Be,action_event_data:Bi.optional()}).meta({cell_class_name:"Action"});class bt extends f{#e=o();get method(){return r(this.#e)}set method(e){n(this.#e,e,!0)}#t=o();get action_event_data(){return r(this.#t)}set action_event_data(e){n(this.#t,e)}#s=l(()=>{const e=hs[this.method];if(!e)throw new Error(`Missing action spec for method '${this.method}'`);return e});get spec(){return r(this.#s)}set spec(e){n(this.#s,e)}#i=l(()=>this.spec.kind);get kind(){return r(this.#i)}set kind(e){n(this.#i,e)}#r=l(()=>!!this.action_event_data?.error);get has_error(){return r(this.#r)}set has_error(e){n(this.#r,e)}#n=l(()=>this.action_event_data?!Se(this.action_event_data):!0);get pending(){return r(this.#n)}set pending(e){n(this.#n,e)}#a=l(()=>this.action_event_data?.step==="failed");get failed(){return r(this.#a)}set failed(e){n(this.#a,e)}#o=l(()=>{if(!this.action_event_data)return!1;const{step:e,error:t}=this.action_event_data;return Se(this.action_event_data)&&e==="handled"&&!t});get success(){return r(this.#o)}set success(e){n(this.#o,e)}constructor(e){super(gs,e),this.init()}unlisten_to_action_event;action_event;listen_to_action_event(e){this.unlisten_to_action_event?.(),this.action_event=e;const t=e.observe(s=>{this.action_event_data=s});return this.unlisten_to_action_event=()=>{t(),this.unlisten_to_action_event=void 0,this.action_event=void 0},this.unlisten_to_action_event}dispose(){super.dispose(),this.unlisten_to_action_event?.()}}A(bt);const ir=512,rr=b.extend({items:h(gs).default(()=>[])}).meta({cell_class_name:"Actions"});class vs extends f{items=new z({indexes:[K({key:"by_method",extractor:e=>e.method,query_schema:Be})]});#e=o(ir);get history_limit(){return r(this.#e)}set history_limit(e){n(this.#e,e,!0)}constructor(e){super(rr,e),e.history_limit!==void 0&&(this.history_limit=e.history_limit),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add_from_json(s)}return j}},this.init()}set_json(e){super.set_json(e),this.#t()}add(e){this.items.add(e),this.#t()}add_from_json(e){const t=new bt({app:this.app,json:e});return this.add(t),t}#t(){const e=this.items.size-this.history_limit;if(e<=0)return;const t=[];for(const s of this.items.by_id.values())if(t.push(s.id),t.length===e)break;this.items.remove_many(t)}}class nr extends Error{class_name;available_classes;constructor(e,t,s){const a=`Class "${e}" is not registered. Available classes: ${t.join(", ")}`;super(a,s),this.name="Class_Not_Registered_Error",this.class_name=e,this.available_classes=t}}class ar{app;#e=new Map;#t=l(()=>Array.from(this.#e.keys()));get class_names(){return r(this.#t)}set class_names(e){n(this.#t,e)}all=new Map;constructor(e){this.app=e}register(e){const t=e.name;this.#e.set(t,e)}unregister(e){return this.#e.delete(e)}maybe_instantiate(e,t,s){const a=this.#e.get(e);return a?new a({...s,app:this.app,json:t}):null}instantiate(e,t,s){const a=this.#e.get(e);if(!a)throw new nr(e,this.class_names);return new a({...s,app:this.app,json:t})}add_cell(e){this.all.set(e.id,e)}remove_cell(e){this.all.delete(e)}}class or extends Error{constructor(e,t=`Unreachable case: ${e}`,s){super(t,s)}}const bs=_().transform(i=>i.trim()).pipe(_().min(1)),lr=bs.default("attr"),ys=_(),_r=ys.default("");c({id:w,key:bs,value:ys});const ws=c({id:Ne,key:lr,value:_r}),Pe=b.extend({type:_(),name:_().default(""),start:g().nullable().default(null),end:g().nullable().default(null),has_xml_tag:v().default(!1),xml_tag_name:_().default(""),attributes:h(ws).default(()=>[]),enabled:v().default(!0),title:_().nullable().default(null),summary:_().nullable().default(null)}),ks=Pe.extend({type:y("text").default("text"),content:_().default("")}),xs=Pe.extend({type:y("diskfile").default("diskfile"),path:x.nullable().default(null),has_xml_tag:Pe.shape.has_xml_tag.default(!0)}),qs=ze("type",[ks,xs]).meta({cell_class_name:"Part"});class be extends f{#e=o();get start(){return r(this.#e)}set start(e){n(this.#e,e,!0)}#t=o();get end(){return r(this.#t)}set end(e){n(this.#t,e,!0)}#s=l(()=>this.content?.length);get length(){return r(this.#s)}set length(e){n(this.#s,e)}#i=l(()=>this.content==null?this.content:G(this.content));get token_count(){return r(this.#i)}set token_count(e){n(this.#i,e)}#r=l(()=>this.content&&this.content.length>Ot?this.content.substring(0,Ot):this.content);get content_preview(){return r(this.#r)}set content_preview(e){n(this.#r,e)}#n=o();get name(){return r(this.#n)}set name(e){n(this.#n,e,!0)}#a=o();get has_xml_tag(){return r(this.#a)}set has_xml_tag(e){n(this.#a,e,!0)}#o=o();get xml_tag_name(){return r(this.#o)}set xml_tag_name(e){n(this.#o,e,!0)}#l=o();get attributes(){return r(this.#l)}set attributes(e){n(this.#l,e,!0)}#_=o();get enabled(){return r(this.#_)}set enabled(e){n(this.#_,e,!0)}#d=o();get title(){return r(this.#d)}set title(e){n(this.#d,e,!0)}#c=o();get summary(){return r(this.#c)}set summary(e){n(this.#c,e,!0)}#h=l(()=>this.type==="diskfile"?"File":"Fragment");get xml_tag_name_default(){return r(this.#h)}set xml_tag_name_default(e){n(this.#h,e)}add_attribute(e=Le){this.attributes.push(ws.parse(e))}update_attribute(e,t){const s=this.attributes.findIndex(u=>u.id===e);if(s===-1)return!1;const a=[...this.attributes],d=a[s];return"key"in t&&t.key!==void 0&&(d.key=t.key),"value"in t&&t.value!==void 0&&(d.value=t.value),this.attributes=a,!0}remove_attribute(e){const t=this.attributes.findIndex(s=>s.id===e);t!==-1&&this.attributes.splice(t,1)}static create(e,t,s){if(!t.type)throw new Error('Missing required "type" field in part JSON');switch(t.type){case"text":return new yt({...s,app:e,json:t});case"diskfile":return new wt({...s,app:e,json:t});default:throw new or(t.type)}}}A(be);class yt extends be{type="text";#e=o();get content(){return r(this.#e)}set content(e){n(this.#e,e,!0)}constructor(e){super(ks,e),this.init()}}A(yt);class wt extends be{type="diskfile";#e=o();get path(){return r(this.#e)}set path(e){if(n(this.#e,e,!0),e===null)return;const s=this.app.diskfiles.get_by_path(e)?.path_relative;if(!s)return;const a=this.attributes.findIndex(d=>d.key.trim()==="path");if(a>=0){const d=[...this.attributes];d[a].value=s,this.attributes=d}else this.add_attribute({key:"path",value:s})}#t=o(null);#s=l(()=>this.path&&this.app.diskfiles.get_by_path(this.path));get diskfile(){return r(this.#s)}set diskfile(e){n(this.#s,e)}#i=l(()=>this.diskfile?.path_relative);get relative_path(){return r(this.#i)}set relative_path(e){n(this.#i,e)}get content(){return r(this.#t)?.current_content??this.diskfile?.content}set content(e){e!=null&&this.path&&this.app.diskfiles.update(this.path,e)}constructor(e){super(xs,e),this.init()}link_editor_state(e){n(this.#t,e,!0)}}A(wt);const dr=i=>{const e=[];for(const t of i){if(!t.enabled)continue;const s=t.content?.trim();if(!s)continue;if(!t.has_xml_tag){e.push(s);continue}const a=t.xml_tag_name.trim()||t.xml_tag_name_default;let d="";for(const u of t.attributes){const S=u.key?.trim()||"";S&&(u.value===""?d+=` ${S}`:d+=` ${S}="${u.value}"`)}e.push(`<${a}${d}>
${s}
</${a}>`)}return e.join(`

`)},Es=b.extend({name:_().default(""),parts:h(qs).default(()=>[])}).meta({cell_class_name:"Prompt"});class le extends f{#e=o();get name(){return r(this.#e)}set name(e){n(this.#e,e,!0)}#t=o();get parts(){return r(this.#t)}set parts(e){n(this.#t,e,!0)}#s=l(()=>dr(this.parts));get content(){return r(this.#s)}set content(e){n(this.#s,e)}#i=l(()=>this.content.length);get length(){return r(this.#i)}set length(e){n(this.#i,e)}#r=l(()=>G(this.content));get token_count(){return r(this.#r)}set token_count(e){n(this.#r,e)}#n=l(()=>Ce(this.content));get content_preview(){return r(this.#n)}set content_preview(e){n(this.#n,e)}constructor(e){super(Es,e),this.init()}add_part(e){return this.parts.push(e),e}remove_part(e){const t=this.parts.findIndex(s=>s.id===e);return t!==-1?(this.parts.splice(t,1),!0):!1}remove_all_parts(){this.parts=[]}reorder_parts(e,t){Bt(this.parts,e,t)}}A(le);const cr=b.extend({items:h(Es).default(()=>[]),selected_id:_().nullable().default(null),show_sort_controls:v().default(!1)}).meta({cell_class_name:"Prompts"});class kt extends f{items=new z({indexes:[H({key:"by_name",extractor:e=>e.name,query_schema:_()}),Q({key:"recent_prompts",compute:e=>e.values.slice().sort((t,s)=>new Date(s.created).getTime()-new Date(t.created).getTime()),onadd:(e,t)=>{const s=e.findIndex(a=>new Date(t.created).getTime()>new Date(a.created).getTime());return s===-1?e.push(t):e.splice(s,0,t),e}}),Q({key:"manual_order",compute:e=>e.values})]});#e=o();#t=o();get selected_id_last_non_null(){return r(this.#t)}set selected_id_last_non_null(e){n(this.#t,e,!0)}get selected_id(){return r(this.#e)}set selected_id(e){n(this.#e,e,!0),e!==null&&(this.selected_id_last_non_null=e)}#s=l(()=>this.selected_id?this.items.by_id.get(this.selected_id):void 0);get selected(){return r(this.#s)}set selected(e){n(this.#s,e)}#i=o();get show_sort_controls(){return r(this.#i)}set show_sort_controls(e){n(this.#i,e,!0)}#r=l(()=>this.items.derived_index("manual_order"));get ordered_items(){return r(this.#r)}set ordered_items(e){n(this.#r,e)}constructor(e){super(cr,e),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}filter_by_part(e){const{id:t}=e;return this.ordered_items.filter(s=>s.parts.some(a=>a.id===t))}add(e){const t=e?.name?e:{...e,name:this.generate_unique_name("new prompt")},s=new le({app:this.app,json:t});return this.items.add(s),this.selected_id===null&&(this.selected_id=s.id),s}generate_unique_name(e="new prompt"){return ce(e,this.items.single_index("by_name"))}add_many(e){const t=e.map(s=>new le({app:this.app,json:s}));return this.items.add_many(t),this.selected_id===null&&t.length>0&&(this.selected_id=t[0].id),t}remove(e){this.items.remove(e.id)&&e.id===this.selected_id&&this.select_next()}remove_many(e){const t=this.selected_id,s=this.items.remove_many(e);return t!==null&&e.includes(t)&&this.select_next(),s}select(e){return this.navigate_to(e)}select_next(){const{by_id:e}=this.items,t=e.values().next();return this.navigate_to(t.value?.id??null)}async navigate_to(e,t=!1){const s=vi(e);if(!(!t&&Me.url.pathname===s))return ie(s)}reorder_prompts(e,t){this.items.indexes.manual_order=ue(this.ordered_items,e,t)}remove_part(e){this.selected&&this.selected.remove_part(e)}toggle_sort_controls(e=!this.show_sort_controls){this.show_sort_controls=e}}A(kt);const hr=b.extend({items:h(qs).default(()=>[])}).meta({cell_class_name:"Parts"});class Ts extends f{items=new z({indexes:[H({key:"by_name",extractor:e=>e.name,query_schema:_()}),H({key:"by_diskfile_path",extractor:e=>e.type==="diskfile"?e.path:void 0,query_schema:_()})]});constructor(e){super(hr,e),this.decoders={items:t=>{if(Array.isArray(t)){this.items.clear();for(const s of t)this.add(s)}return j}},this.init()}add(e){const t=e.name?e:{...e,name:this.generate_unique_name("new part")},s=be.create(this.app,t);return this.items.add(s),s}generate_unique_name(e="new part"){return ce(e,this.items.single_index("by_name"))}remove(e){return this.items.remove(e)}find_part_by_diskfile_path(e){return this.items.single_index("by_diskfile_path").get(e)}}const ur=b.extend({}).meta({cell_class_name:"Time"});class ye extends f{static DEFAULT_INTERVAL=6e4;now=new Ie;#e=l(()=>this.now.getTime());get now_ms(){return r(this.#e)}set now_ms(e){n(this.#e,e)}#t=l(()=>Cs(this.now));get now_timestamp(){return r(this.#t)}set now_timestamp(e){n(this.#t,e)}#s=l(()=>Ms(this.now));get now_formatted_short_date(){return r(this.#s)}set now_formatted_short_date(e){n(this.#s,e)}#i=l(()=>Is(this.now));get now_formatted_datetime(){return r(this.#i)}set now_formatted_datetime(e){n(this.#i,e)}#r=l(()=>Ls(this.now));get now_formatted_time(){return r(this.#r)}set now_formatted_time(e){n(this.#r,e)}#n=o(I(ye.DEFAULT_INTERVAL));get interval(){return r(this.#n)}set interval(e){n(this.#n,e,!0)}#a=o(!1);get running(){return r(this.#a)}set running(e){n(this.#a,e,!0)}#o;constructor(e){super(ur,e),(e.autostart??Ws)&&this.start(),this.init()}start(){return this.running?!1:(this.#o=setInterval(()=>{this.update_now(Date.now())},this.interval),this.running=!0,!0)}stop(){return this.running?(this.#o&&(clearInterval(this.#o),this.#o=void 0),this.running=!1,!0):!1}restart(e){e!==void 0&&(this.interval=e),this.stop(),this.start()}update_now(e=Date.now()){this.now.setTime(e)}destroy(){this.stop()}}class xt{static DEFAULT_INTERVAL=15e3;#e=o(!1);get active(){return r(this.#e)}#t=null;#s;#i;#r;constructor(e){this.#s=e.poll_fn,this.#i=e.interval??xt.DEFAULT_INTERVAL,this.#r=e.immediate??!0}start(e){if(r(this.#e))return;const t=e?.immediate??this.#r,s=e?.interval??this.#i;n(this.#e,!0),t&&this.#n(),this.#t=setInterval(()=>{this.#n()},s)}stop(){r(this.#e)&&(n(this.#e,!1),this.#t&&(clearInterval(this.#t),this.#t=null))}set_interval(e){e===void 0||this.#i===e||(this.#i=e,r(this.#e)&&(this.stop(),this.start()))}dispose(){this.stop()}#n(){if(r(this.#e))try{const e=this.#s();e instanceof Promise&&e.catch(t=>{this.#a(t)})}catch(e){this.#a(e)}}#a(e){console.error("[poller] poll function error:",e)}}const De="no response from Ollama server",zt=b.extend({host:_().default(Zs)}).meta({cell_class_name:"Ollama"});class pr extends f{#e=o();#t=o(null);get list_response(){return r(this.#t)}set list_response(e){n(this.#t,e)}#s=o("initial");get list_status(){return r(this.#s)}set list_status(e){n(this.#s,e,!0)}#i=o(null);get list_error(){return r(this.#i)}set list_error(e){n(this.#i,e,!0)}#r=o(null);get list_last_updated(){return r(this.#r)}set list_last_updated(e){n(this.#r,e,!0)}#n=o(null);get list_round_trip_time(){return r(this.#n)}set list_round_trip_time(e){n(this.#n,e,!0)}#a=o(null);get last_refreshed(){return r(this.#a)}set last_refreshed(e){n(this.#a,e,!0)}#o=o(!1);get ever_responded(){return r(this.#o)}set ever_responded(e){n(this.#o,e,!0)}#l=o(null);get ps_response(){return r(this.#l)}set ps_response(e){n(this.#l,e)}#_=o("initial");get ps_status(){return r(this.#_)}set ps_status(e){n(this.#_,e,!0)}#d=o(null);get ps_error(){return r(this.#d)}set ps_error(e){n(this.#d,e,!0)}#c=o(!1);get ps_polling_enabled(){return r(this.#c)}set ps_polling_enabled(e){n(this.#c,e,!0)}#h;#u=o("");get pull_model_name(){return r(this.#u)}set pull_model_name(e){n(this.#u,e,!0)}#p=o(!1);get pull_insecure(){return r(this.#p)}set pull_insecure(e){n(this.#p,e,!0)}pulling_models=new se;#m=o("");get copy_source_model(){return r(this.#m)}set copy_source_model(e){n(this.#m,e,!0)}#f=o("");get copy_destination_model(){return r(this.#f)}set copy_destination_model(e){n(this.#f,e,!0)}#v=o(!1);get copy_is_copying(){return r(this.#v)}set copy_is_copying(e){n(this.#v,e,!0)}#g=o("");get create_model_name(){return r(this.#g)}set create_model_name(e){n(this.#g,e,!0)}#b=o("");get create_from_model(){return r(this.#b)}set create_from_model(e){n(this.#b,e,!0)}#y=o("");get create_system_prompt(){return r(this.#y)}set create_system_prompt(e){n(this.#y,e,!0)}#w=o("");get create_template(){return r(this.#w)}set create_template(e){n(this.#w,e,!0)}#k=o(!1);get create_is_creating(){return r(this.#k)}set create_is_creating(e){n(this.#k,e,!0)}#T=o("configure");get manager_selected_view(){return r(this.#T)}set manager_selected_view(e){n(this.#T,e,!0)}#D=o(null);get manager_selected_model(){return r(this.#D)}set manager_selected_model(e){n(this.#D,e,!0)}#A=o(null);get manager_last_active_view(){return r(this.#A)}set manager_last_active_view(e){n(this.#A,e,!0)}#O=o(!1);get show_read_actions(){return r(this.#O)}set show_read_actions(e){n(this.#O,e,!0)}get host(){return r(this.#e)}set host(e){n(this.#e,zt.shape.host.parse(e),!0)}#R=l(()=>this.list_status==="success"||this.ps_status==="success"||this.ever_responded&&(this.list_status==="pending"||this.ps_status==="pending"));get available(){return r(this.#R)}set available(e){n(this.#R,e)}#J=l(()=>this.app.actions.items.values.filter(e=>e.method.startsWith("ollama_")).sort((e,t)=>e.created>t.created?-1:1));get actions(){return r(this.#J)}set actions(e){n(this.#J,e)}#C=l(()=>this.actions.filter(e=>e.action_event_data?.step==="handling"));get pending_actions(){return r(this.#C)}set pending_actions(e){n(this.#C,e)}#S=l(()=>this.actions.filter(e=>e.action_event_data?.step==="handled"||e.action_event_data?.step==="failed"));get completed_actions(){return r(this.#S)}set completed_actions(e){n(this.#S,e)}#P=l(()=>this.show_read_actions?this.actions:this.actions.filter(e=>e.method!=="ollama_list"&&e.method!=="ollama_show"&&e.method!=="ollama_ps"));get filtered_actions(){return r(this.#P)}set filtered_actions(e){n(this.#P,e)}#E=l(()=>this.app.models.items.where("provider_name","ollama"));get models(){return r(this.#E)}set models(e){n(this.#E,e)}#x=l(()=>this.models.filter(e=>e.downloaded));get models_downloaded(){return r(this.#x)}set models_downloaded(e){n(this.#x,e)}#q=l(()=>this.models.filter(e=>!e.downloaded));get models_not_downloaded(){return r(this.#q)}set models_not_downloaded(e){n(this.#q,e)}#$=l(()=>ts(this.models,"name"));get model_by_name(){return r(this.#$)}set model_by_name(e){n(this.#$,e)}#j=l(()=>Array.from(this.model_by_name.keys()));get model_names(){return r(this.#j)}set model_names(e){n(this.#j,e)}#z=l(()=>this.ps_response?.models??[]);get running_models(){return r(this.#z)}set running_models(e){n(this.#z,e)}#N=l(()=>new Set(this.running_models.map(e=>e.name)));get running_model_names(){return r(this.#N)}set running_model_names(e){n(this.#N,e)}#M=l(()=>C.parse(this.pull_model_name));get pull_parsed_model_name(){return r(this.#M)}set pull_parsed_model_name(e){n(this.#M,e)}#I=l(()=>!!(this.pull_parsed_model_name&&this.model_by_name.get(this.pull_parsed_model_name)?.downloaded));get pull_already_downloaded(){return r(this.#I)}set pull_already_downloaded(e){n(this.#I,e)}#L=l(()=>!!this.pull_parsed_model_name&&!this.pull_already_downloaded&&!this.pulling_models.has(this.pull_parsed_model_name));get pull_can_pull(){return r(this.#L)}set pull_can_pull(e){n(this.#L,e)}pull_is_pulling(e){return this.pulling_models.has(e)}#U=l(()=>C.parse(this.copy_source_model));get copy_parsed_source_model(){return r(this.#U)}set copy_parsed_source_model(e){n(this.#U,e)}#F=l(()=>C.parse(this.copy_destination_model));get copy_parsed_destination_model(){return r(this.#F)}set copy_parsed_destination_model(e){n(this.#F,e)}#W=l(()=>!!this.copy_parsed_destination_model&&this.model_by_name.has(this.copy_parsed_destination_model));get copy_is_duplicate_name(){return r(this.#W)}set copy_is_duplicate_name(e){n(this.#W,e)}#V=l(()=>!!this.copy_parsed_source_model&&!!this.copy_parsed_destination_model&&!this.copy_is_duplicate_name);get copy_destination_model_changed(){return r(this.#V)}set copy_destination_model_changed(e){n(this.#V,e)}#H=l(()=>C.parse(this.create_model_name));get create_parsed_model_name(){return r(this.#H)}set create_parsed_model_name(e){n(this.#H,e)}#Y=l(()=>!!this.create_parsed_model_name&&this.model_by_name.has(this.create_parsed_model_name));get create_is_duplicate_name(){return r(this.#Y)}set create_is_duplicate_name(e){n(this.#Y,e)}#G=l(()=>!!this.create_parsed_model_name&&!this.create_is_duplicate_name);get create_can_create(){return r(this.#G)}set create_can_create(e){n(this.#G,e)}constructor(e){super(zt,e),this.#h=new xt({poll_fn:()=>{this.ps_polling_enabled&&this.available&&this.app.api.ollama_ps()},immediate:!0}),this.init()}dispose(){this.#h.dispose(),super.dispose()}async refresh(){if(!this.app.lookup_provider_status("ollama")?.available)return{list_response:null,ps_response:null};const[t,s]=await Promise.all([this.app.api.ollama_list(),this.app.api.ollama_ps()]),a=t.ok?t.value:null,d=s.ok?s.value:null;return(t.ok||s.ok)&&(this.last_refreshed=de()),{list_response:a,ps_response:d}}start_ps_polling(e){this.ps_polling_enabled||(this.ps_polling_enabled=!0,console.log("[ollama.start_ps_polling] starting ps polling"),this.#h.start(e))}stop_ps_polling(){this.ps_polling_enabled&&(console.log("[ollama.stop_ps_polling] stopping ps polling"),this.ps_polling_enabled=!1,this.#h.stop())}handle_ollama_list_start(){console.log("[ollama.handle_ollama_list_start] starting list request"),this.list_status="pending"}handle_ollama_list_complete(e){if(!e){console.error("[ollama.handle_ollama_list_complete] no response"),this.list_response=null,this.list_status="failure",this.list_error=De,this.list_round_trip_time=null;return}console.log(`[ollama.handle_ollama_list_complete] success, found ${e.models.length} models`,e),this.list_response=e,this.list_status="success",this.list_error=null,this.list_last_updated=Date.now(),this.ever_responded=!0,this.#X(e)}handle_ollama_ps_start(){console.log("[ollama.handle_ollama_ps_start] starting ps request"),this.ps_status="pending"}handle_ollama_ps_complete(e){if(!e){console.error("[ollama.handle_ollama_ps_complete] no response"),this.ps_response=null,this.ps_status="failure",this.ps_error=De;return}console.log(`[ollama.handle_ollama_ps_complete] success, found ${e.models.length} running models`,e),this.ps_response=e,this.ps_status="success",this.ps_error=null,this.ever_responded=!0}handle_ollama_show(e,t){const s=this.app.models.find_by_name(e.model);if(!s){console.error(`[ollama.handle_ollama_show] model not found: ${e.model}`);return}if(s.provider_name!=="ollama"){console.error(`[ollama.handle_ollama_show] model not an ollama model: ${e.model}`);return}if(!t){console.error(`[ollama.handle_ollama_show] no response for: ${e.model}`),s.ollama_show_response_loading=!1,s.ollama_show_response_error=De;return}console.log(`[ollama.handle_ollama_show] success for: ${e.model}`,t),t.tensors=void 0,s.ollama_show_response=t,s.ollama_show_response_loaded=!0,s.ollama_show_response_loading=!1,s.ollama_show_response_error=void 0}async handle_ollama_delete(e){console.log(`[ollama.handle_ollama_delete] deleting: ${e.model}`),await this.refresh()}clear_model_details(e){e.provider_name==="ollama"&&(e.ollama_show_response=void 0,e.ollama_show_response_loaded=!1,e.ollama_show_response_error=void 0)}clear_all_model_details(){for(const e of this.models)this.clear_model_details(e)}async pull(){!this.pull_can_pull||!(await this.app.api.ollama_pull({model:this.pull_parsed_model_name,insecure:this.pull_insecure,_meta:{progressToken:E()}})).ok||await this.refresh()}async copy(){!this.copy_destination_model_changed||(await this.app.api.ollama_copy({source:this.copy_parsed_source_model,destination:this.copy_parsed_destination_model})).ok}async create(){!this.create_can_create||(await this.app.api.ollama_create({model:this.create_parsed_model_name,from:this.create_from_model.trim()||void 0,system:this.create_system_prompt.trim()||void 0,template:this.create_template.trim()||void 0,_meta:{progressToken:E()}})).ok}async delete(e){console.log(`[ollama.delete_model] deleting from manager: ${e}`),(await this.app.api.ollama_delete({model:e})).ok&&this.manager_selected_model?.name===e&&this.set_manager_view("configure",null)}async unload(e){console.log(`[ollama.unload] unloading from memory: ${e}`),(await this.app.api.ollama_unload({model:e})).ok&&await this.app.api.ollama_ps()}async select(e){this.set_manager_view("model",e),e.needs_ollama_details&&(await this.app.api.ollama_show({model:e.name})).ok}close_form(){this.set_manager_view("configure",null)}set_manager_view(e,t){this.manager_selected_view!=="configure"&&this.manager_selected_view!==e&&(this.manager_last_active_view={view:this.manager_selected_view,model:this.manager_selected_model}),this.manager_selected_view=e,t!==void 0&&(this.manager_selected_model=t)}manager_back_to_last_view(){if(this.manager_last_active_view){const e=this.manager_last_active_view;this.manager_last_active_view=null,this.manager_selected_view=e.view,this.manager_selected_model=e.model}}#X(e){const t=new Map(this.models.map(s=>[s.name,s]));for(const s of e.models){const a=t.get(s.name);a?(a.filesize=s.size/(1024*1024*1024),a.ollama_list_response_item=s,t.delete(s.name)):this.app.models.add({name:s.name,provider_name:"ollama",filesize:s.size/(1024*1024*1024),parameter_count:ci(s.details?.parameter_size),architecture:s.details?.family,ollama_list_response_item:s})}for(const s of t.values())s.ollama_list_response_item=void 0,this.clear_model_details(s)}}const mr=6,fr=b.extend({}).meta({cell_class_name:"Capabilities"});class Ds extends f{#e=o({name:"backend",data:void 0,status:"initial",message_id:null,error_message:null,updated:null});get backend(){return r(this.#e)}set backend(e){n(this.#e,e)}#t=l(()=>{const{socket:e}=this.app,{status:t}=e,s=t==="initial"?void 0:{url:e.url,connected:e.connected,reconnect_count:e.reconnect_count,last_connect_time:e.last_connect_time,last_send_time:e.last_send_time,last_receive_time:e.last_receive_time,connection_duration:e.connection_duration,pending_pings:this.pending_ping_count};return{name:"websocket",data:s,status:t,message_id:null,error_message:null,updated:s?.last_connect_time??null}});get websocket(){return r(this.#t)}set websocket(e){n(this.#t,e)}#s=l(()=>{const{zzz_cache_dir:e}=this.app;let t;return this.backend.status!=="success"?t=this.backend.status:e===void 0?t="initial":e===null?t="pending":e===""?t="failure":t="success",{name:"filesystem",data:t==="success"?{zzz_cache_dir:e}:void 0,status:t,message_id:null,error_message:null,updated:Date.now()}});get filesystem(){return r(this.#s)}set filesystem(e){n(this.#s,e)}#i=l(()=>{const{ollama:e}=this.app,t=this.app.lookup_provider_status("ollama");if(t){if(!t.available)return{name:"ollama",data:null,status:"failure",message_id:null,error_message:t.error,updated:t.checked_at};const{list_status:a}=e;return{name:"ollama",data:a==="success"?{list_response:e.list_response,ps_response:e.ps_response,round_trip_time:e.list_round_trip_time}:null,status:a==="initial"?"success":a,message_id:null,error_message:e.list_error,updated:t.checked_at}}const{list_status:s}=e;return{name:"ollama",data:s==="initial"?void 0:s==="success"?{list_response:e.list_response,ps_response:e.ps_response,round_trip_time:e.list_round_trip_time}:null,status:s,message_id:null,error_message:e.list_error,updated:e.list_last_updated}});get ollama(){return r(this.#i)}set ollama(e){n(this.#i,e)}#r=l(()=>{const e=this.app.lookup_provider_status("claude");return e?{name:"claude",data:e.available?null:void 0,status:e.available?"success":"failure",message_id:null,error_message:e.available?null:e.error,updated:e.checked_at}:{name:"claude",data:void 0,status:"initial",message_id:null,error_message:null,updated:null}});get claude(){return r(this.#r)}set claude(e){n(this.#r,e)}#n=l(()=>{const e=this.app.lookup_provider_status("chatgpt");return e?{name:"chatgpt",data:e.available?null:void 0,status:e.available?"success":"failure",message_id:null,error_message:e.available?null:e.error,updated:e.checked_at}:{name:"chatgpt",data:void 0,status:"initial",message_id:null,error_message:null,updated:null}});get chatgpt(){return r(this.#n)}set chatgpt(e){n(this.#n,e)}#a=l(()=>{const e=this.app.lookup_provider_status("gemini");return e?{name:"gemini",data:e.available?null:void 0,status:e.available?"success":"failure",message_id:null,error_message:e.available?null:e.error,updated:e.checked_at}:{name:"gemini",data:void 0,status:"initial",message_id:null,error_message:null,updated:null}});get gemini(){return r(this.#a)}set gemini(e){n(this.#a,e)}#o=o(I([]));get pings(){return r(this.#o)}set pings(e){n(this.#o,e,!0)}#l=l(()=>this.pings.find(e=>e.completed)?.round_trip_time??null);get latest_ping_time(){return r(this.#l)}set latest_ping_time(e){n(this.#l,e)}#_=l(()=>this.pings.filter(e=>e.completed));get completed_pings(){return r(this.#_)}set completed_pings(e){n(this.#_,e)}#d=l(()=>this.pings.filter(e=>!e.completed).length);get pending_ping_count(){return r(this.#d)}set pending_ping_count(e){n(this.#d,e)}#c=l(()=>this.pending_ping_count>0);get has_pending_pings(){return r(this.#c)}set has_pending_pings(e){n(this.#c,e)}#h=l(()=>this.backend.data===void 0?void 0:this.backend.status==="pending"?null:this.backend.status==="success"&&this.backend.data!==null);get backend_available(){return r(this.#h)}set backend_available(e){n(this.#h,e)}#u=l(()=>this.ollama.data===void 0?void 0:this.ollama.status==="pending"?null:this.ollama.status==="success"&&this.ollama.data!==null);get ollama_available(){return r(this.#u)}set ollama_available(e){n(this.#u,e)}#p=l(()=>this.websocket.data===void 0?void 0:this.websocket.status==="pending"?null:this.websocket.status==="success");get websocket_available(){return r(this.#p)}set websocket_available(e){n(this.#p,e)}#m=l(()=>this.filesystem.status==="initial"?void 0:this.filesystem.status==="pending"?null:this.filesystem.status==="success");get filesystem_available(){return r(this.#m)}set filesystem_available(e){n(this.#m,e)}#f=l(()=>this.app.ollama.models_downloaded.filter(e=>!!e.ollama_list_response_item).map(e=>({name:e.name,size:Math.round((e.filesize??0)*1024),model_response:e.ollama_list_response_item})));get ollama_models(){return r(this.#f)}set ollama_models(e){n(this.#f,e)}constructor(e){super(fr,e)}async init_backend_check(){this.backend.status==="initial"&&await this.check_backend()}async check_backend(){await this.app.api.ping()}async init_ollama_check(){this.ollama.status==="initial"&&await this.check_ollama()}async check_ollama(){if(!this.backend_available){console.log("[capabilities] skipping ollama check: backend unavailable");return}await this.app.api.provider_load_status({provider_name:"ollama"}),await this.app.ollama.refresh()}handle_ping_sent(e){console.log("[capabilities] [handle_ping_sent] request_id",e);const t={ping_id:e,completed:!1,sent_time:Date.now(),received_time:null,round_trip_time:null};this.pings=[t,...this.pings.slice(0,mr-1)],this.backend={name:"backend",data:null,status:"pending",message_id:e,error_message:null,updated:Date.now()}}handle_ping_received(e){console.log("[capabilities] [handle_ping_received] ping_id",e);const t=this.pings.find(a=>a.ping_id===e);if(!t)return;const s=Date.now();t.completed=!0,t.received_time=s,t.round_trip_time=s-t.sent_time,this.backend.message_id===e&&(this.backend={name:"backend",data:{round_trip_time:t.round_trip_time},status:"success",message_id:e,error_message:null,updated:Date.now()})}handle_ping_error(e,t){console.error("[capabilities] [handle_ping_error] ping_id",e,t);const s=this.pings.find(a=>a.ping_id===e);s&&(s.completed=!0,s.received_time=Date.now(),s.round_trip_time=null),this.backend.message_id===e&&(this.backend={name:"backend",data:null,status:"failure",message_id:e,error_message:t,updated:Date.now()})}reset_backend(){this.backend={name:"backend",data:void 0,status:"initial",message_id:null,error_message:null,updated:null}}async init_claude_check(){this.claude.status==="initial"&&await this.check_claude()}async check_claude(){if(!this.backend_available){console.log("[capabilities] skipping claude check: backend unavailable");return}await this.app.api.provider_load_status({provider_name:"claude"})}async init_chatgpt_check(){this.chatgpt.status==="initial"&&await this.check_chatgpt()}async check_chatgpt(){if(!this.backend_available){console.log("[capabilities] skipping chatgpt check: backend unavailable");return}await this.app.api.provider_load_status({provider_name:"chatgpt"})}async init_gemini_check(){this.gemini.status==="initial"&&await this.check_gemini()}async check_gemini(){if(!this.backend_available){console.log("[capabilities] skipping gemini check: backend unavailable");return}await this.app.api.provider_load_status({provider_name:"gemini"})}}const gr=c({id:Ne,created:g(),content:_(),label:_(),is_disk_change:v().default(!1),is_unsaved_edit:v().default(!1),is_original_state:v().default(!1)}),vr=b.extend({path:x,entries:h(gr).default(()=>[]),max_entries:g().default(100)}).meta({cell_class_name:"Diskfile_History"});class As extends f{#e=o();get path(){return r(this.#e)}set path(e){n(this.#e,e,!0)}#t=o();get entries(){return r(this.#t)}set entries(e){n(this.#t,e,!0)}#s=o();get max_entries(){return r(this.#s)}set max_entries(e){n(this.#s,e,!0)}#i=l(()=>this.entries.length>0?this.entries[0]:null);get current_entry(){return r(this.#i)}set current_entry(e){n(this.#i,e)}constructor(e){super(vr,e),this.init()}add_entry(e,t=Le){if(this.current_entry&&this.current_entry.content===e&&this.#r(this.current_entry,t))return this.current_entry;const s={id:E(),created:t.created??Date.now(),content:e,label:t.label??"",is_disk_change:t.is_disk_change??!1,is_unsaved_edit:t.is_unsaved_edit??!1,is_original_state:t.is_original_state??!1};let a=[...this.entries],d=0;for(;d<a.length&&a[d].created>s.created;)d++;return a.splice(d,0,s),a.length>this.max_entries&&(a=a.slice(0,this.max_entries)),this.entries=a,s}#r(e,t){return e.is_disk_change===(t.is_disk_change??e.is_disk_change)&&e.is_unsaved_edit===(t.is_unsaved_edit??e.is_unsaved_edit)&&e.is_original_state===(t.is_original_state??e.is_original_state)&&e.label===(t.label??e.label)}find_entry_by_id(e){return this.entries.find(t=>t.id===e)}get_content(e){const t=this.find_entry_by_id(e);return t?t.content:null}clear_except_current(e){if(this.entries.length<=1)return;const t=this.entries.length?this.entries[0]:null;this.entries=this.entries.filter(s=>t&&s.id===t.id?!0:e?e(s):!1)}}const br=3e5,yr=1e3,wr=1e4,kr=!0,xr=1e3,J=b.extend({url:_().nullable().default(null),url_input:_().default(""),heartbeat_interval:g().int().positive().default(br),reconnect_delay:g().int().positive().default(yr),reconnect_delay_max:g().int().positive().default(wr),auto_reconnect:v().default(kr)}).meta({cell_class_name:"Socket"});class Os extends f{#e=o();#t=o();#s=o();#i=o();#r=o();#n=o();#a=o(null);get ws(){return r(this.#a)}set ws(e){n(this.#a,e,!0)}#o=o(!1);get open(){return r(this.#o)}set open(e){n(this.#o,e,!0)}#l=o("initial");get status(){return r(this.#l)}set status(e){n(this.#l,e,!0)}#_=o(null);get last_send_time(){return r(this.#_)}set last_send_time(e){n(this.#_,e,!0)}#d=o(null);get last_receive_time(){return r(this.#d)}set last_receive_time(e){n(this.#d,e,!0)}#c=o(null);get last_connect_time(){return r(this.#c)}set last_connect_time(e){n(this.#c,e,!0)}#h=o(null);get heartbeat_timeout(){return r(this.#h)}set heartbeat_timeout(e){n(this.#h,e,!0)}#u=o(0);get reconnect_count(){return r(this.#u)}set reconnect_count(e){n(this.#u,e,!0)}#p=o(0);get reconnect_attempt(){return r(this.#p)}set reconnect_attempt(e){n(this.#p,e,!0)}#m=o(null);get reconnect_timeout(){return r(this.#m)}set reconnect_timeout(e){n(this.#m,e,!0)}#f=o(0);get current_reconnect_delay(){return r(this.#f)}set current_reconnect_delay(e){n(this.#f,e,!0)}#v=o(I([]));get message_queue(){return r(this.#v)}set message_queue(e){n(this.#v,e,!0)}failed_messages=new L;#g=new Set;#b=new Set;#y=l(()=>this.open&&this.status==="success");get connected(){return r(this.#y)}set connected(e){n(this.#y,e)}#w=l(()=>this.connected&&this.ws!==null);get can_send(){return r(this.#w)}set can_send(e){n(this.#w,e)}#k=l(()=>this.message_queue.length>0);get has_queued_messages(){return r(this.#k)}set has_queued_messages(e){n(this.#k,e)}#T=l(()=>this.message_queue.length);get queued_message_count(){return r(this.#T)}set queued_message_count(e){n(this.#T,e)}#D=l(()=>this.failed_messages.size);get failed_message_count(){return r(this.#D)}set failed_message_count(e){n(this.#D,e)}#A=l(()=>this.connected&&this.last_connect_time?Math.max(0,this.app.time.now_ms-this.last_connect_time):null);get connection_duration(){return r(this.#A)}set connection_duration(e){n(this.#A,e)}#O=l(()=>this.connection_duration!==null?Math.round(this.connection_duration/this.app.time.interval)*this.app.time.interval:null);get connection_duration_rounded(){return r(this.#O)}set connection_duration_rounded(e){n(this.#O,e)}get url(){return r(this.#e)}set url(e){n(this.#e,J.shape.url.parse(e),!0)}get url_input(){return r(this.#t)}set url_input(e){n(this.#t,J.shape.url_input.parse(e),!0)}get heartbeat_interval(){return r(this.#s)}set heartbeat_interval(e){n(this.#s,J.shape.heartbeat_interval.parse(e),!0)}get reconnect_delay(){return r(this.#i)}set reconnect_delay(e){n(this.#i,J.shape.reconnect_delay.parse(e),!0)}get reconnect_delay_max(){return r(this.#r)}set reconnect_delay_max(e){n(this.#r,J.shape.reconnect_delay_max.parse(e),!0)}get auto_reconnect(){return r(this.#n)}set auto_reconnect(e){n(this.#n,J.shape.auto_reconnect.parse(e),!0)}constructor(e){super(J,e),this.init(),this.url&&(this.url_input=this.url)}connect(e=null){if(this.disconnect(),e!==null?(this.url=e,this.url_input=e):this.url_input&&(this.url=this.url_input),!this.url){console.error("[socket] cannot connect: no URL provided");return}try{this.status="pending";const t=new WebSocket(this.url);this.ws=t,t.addEventListener("open",this.#$),t.addEventListener("close",this.#j),t.addEventListener("error",this.#z),t.addEventListener("message",this.#N)}catch(t){console.error("[socket] failed to create WebSocket:",t),this.ws=null,this.open=!1,this.status="failure",this.#x()}}disconnect(e=xr){if(this.#q(),this.#E(),this.ws){if(this.ws.removeEventListener("open",this.#$),this.ws.removeEventListener("close",this.#j),this.ws.removeEventListener("error",this.#z),this.ws.removeEventListener("message",this.#N),this.open)try{this.ws.close(e)}catch(t){console.error("[socket] error closing WebSocket:",t)}this.ws=null,this.open=!1}this.status="initial"}send(e){if(this.can_send)try{return this.ws.send(JSON.stringify(e)),this.last_send_time=Date.now(),!0}catch(t){return console.error("[socket] error sending message:",t),this.#R(e),!1}else return this.#R(e),!1}update_url(e){if(this.url===e)return;const t=this.connected;this.url=e,this.url_input=e,t&&this.connect()}async send_heartbeat(){await this.app.api.ping()}retry_queued_messages(){if(!this.can_send||this.message_queue.length===0)return;const e=[...this.message_queue];this.message_queue=[];for(const t of e)this.#J(t)}clear_failed_messages(){this.failed_messages.clear()}#R(e){const t={id:E(),data:e,created:Date.now()};this.message_queue.push(t),this.status==="initial"&&this.auto_reconnect&&this.connect()}#J(e){if(!this.can_send){this.message_queue.push(e);return}try{this.ws.send(JSON.stringify(e.data)),this.last_send_time=Date.now()}catch(t){const s={...e,failed:Date.now(),reason:t instanceof Error?t.message:V};this.failed_messages.set(e.id,s)}}#C(){this.#E();const e=Date.now();this.last_send_time=e,this.last_receive_time=e,this.#S()}#S(){this.#E(),this.heartbeat_timeout=setTimeout(()=>{const e=Date.now();this.#P()<=e&&this.send_heartbeat(),this.#S()},Math.max(100,this.#P()-Date.now()))}#P(){return Math.max(this.last_send_time??0,this.last_receive_time??0)+this.heartbeat_interval}#E(){this.heartbeat_timeout!==null&&(clearTimeout(this.heartbeat_timeout),this.heartbeat_timeout=null)}#x(){this.auto_reconnect&&(this.#q(),this.reconnect_count++,this.reconnect_attempt++,this.current_reconnect_delay=Math.round(Math.min(this.reconnect_delay_max,this.reconnect_delay*1.5**(this.reconnect_count-1))),this.reconnect_timeout=setTimeout(()=>{this.reconnect_timeout=null,this.connect()},this.current_reconnect_delay))}maybe_reconnect(){this.#x()}cancel_reconnect(){this.#q()}add_message_handler(e){return this.#g.add(e),()=>this.#g.delete(e)}add_error_handler(e){return this.#b.add(e),()=>this.#b.delete(e)}#q(){this.reconnect_timeout!==null&&(clearTimeout(this.reconnect_timeout),this.reconnect_timeout=null)}#$=e=>{this.open=!0,this.status="success",this.reconnect_count=0,this.#q(),this.#C(),this.last_connect_time=Date.now(),this.has_queued_messages&&this.retry_queued_messages()};#j=e=>{this.open=!1,(this.status==="success"||this.status==="pending")&&(this.status="failure",this.#x())};#z=e=>{for(const t of this.#b)t(e);console.error("[socket] websocket error occurred:",e),this.status="failure",this.open=!1,this.#x()};#N=e=>{this.last_receive_time=Date.now();for(const t of this.#g)t(e)}}const $e=b.extend({show_main_dialog:v().default(!1),show_sidebar:v().default(!0),tutorial_for_database:v().default(!0),tutorial_for_chats:v().default(!0),tutorial_for_prompts:v().default(!0),tutorial_for_diskfiles:v().default(!0)}).meta({cell_class_name:"Ui"});class Rs extends f{#e=o();get show_main_dialog(){return r(this.#e)}set show_main_dialog(e){n(this.#e,e,!0)}#t=o();get show_sidebar(){return r(this.#t)}set show_sidebar(e){n(this.#t,e,!0)}#s=o();get tutorial_for_database(){return r(this.#s)}set tutorial_for_database(e){n(this.#s,e,!0)}#i=o();get tutorial_for_chats(){return r(this.#i)}set tutorial_for_chats(e){n(this.#i,e,!0)}#r=o();get tutorial_for_prompts(){return r(this.#r)}set tutorial_for_prompts(e){n(this.#r,e,!0)}#n=o();get tutorial_for_diskfiles(){return r(this.#n)}set tutorial_for_diskfiles(e){n(this.#n,e,!0)}#a=o(null);get pending_element_to_focus_key(){return r(this.#a)}set pending_element_to_focus_key(e){n(this.#a,e,!0)}constructor(e){super($e,e),this.init()}toggle_main_menu(e=!this.show_main_dialog){return this.show_main_dialog=e,e}toggle_sidebar(e=!this.show_sidebar){return this.show_sidebar=e,e}}const qr={Parts:Ts,Capabilities:Ds,Chat:ae,Chats:Ve,Diskfile:He,Diskfile_Tab:Ye,Diskfile_Tabs:Ge,Diskfile_Part:wt,Diskfile_History:As,Diskfiles:ss,Diskfiles_Editor:Xe,Model:re,Models:Ft,Action:bt,Actions:vs,Prompt:le,Prompts:kt,Provider:Mt,Providers:Zt,Socket:Os,Turn:We,Thread:ne,Threads:Qt,Time:ye,Text_Part:yt,Ui:Rs},Er=i=>`${i}_action_spec`;class Tr{specs;constructor(e){this.specs=e}get spec_by_method(){return new Map(this.specs.map(e=>[e.method,e]))}get request_response_specs(){return this.specs.filter(e=>e.kind==="request_response")}get remote_notification_specs(){return this.specs.filter(e=>e.kind==="remote_notification")}get local_call_specs(){return this.specs.filter(e=>e.kind==="local_call")}get backend_specs(){return this.specs.filter(e=>e.kind!=="local_call")}get frontend_specs(){return this.specs}get backend_to_frontend_specs(){return this.specs.filter(e=>e.initiator==="backend"||e.initiator==="both")}get frontend_to_backend_specs(){return this.specs.filter(e=>e.initiator==="frontend"||e.initiator==="both")}get methods(){return this.specs.map(e=>e.method)}get request_response_methods(){return this.request_response_specs.map(e=>e.method)}get remote_notification_methods(){return this.remote_notification_specs.map(e=>e.method)}get local_call_methods(){return this.local_call_specs.map(e=>e.method)}get backend_methods(){return this.backend_specs.map(e=>e.method)}get frontend_methods(){return this.frontend_specs.map(e=>e.method)}get frontend_to_backend_methods(){return this.frontend_to_backend_specs.map(e=>e.method)}get backend_to_frontend_methods(){return this.backend_to_frontend_specs.map(e=>e.method)}get_schema_imports(){return this.specs.map(e=>Er(e.method))}}const Dr=(i,e)=>Wi[i].safeParse(e),Ar=(i,e)=>Vi[i].safeParse(e),p={parse_error:os,invalid_request:ls,method_not_found:_s,invalid_params:ds,internal_error:Qe,unauthenticated:-32001,forbidden:-32002,not_found:-32003,conflict:-32004,validation_error:-32005,rate_limited:-32006,service_unavailable:-32007,timeout:-32008,ai_provider_error:-32020},R={parse_error:i=>({code:p.parse_error,message:"parse error",data:i}),invalid_request:i=>({code:p.invalid_request,message:"invalid request",data:i}),method_not_found:(i,e)=>({code:p.method_not_found,message:i?`method not found: ${i}`:"method not found",data:e}),invalid_params:(i,e)=>({code:p.invalid_params,message:i??"invalid params",data:e}),internal_error:(i="internal server error",e)=>({code:p.internal_error,message:i,data:e}),unauthenticated:(i="unauthenticated",e)=>({code:p.unauthenticated,message:i,data:e}),forbidden:(i="forbidden",e)=>({code:p.forbidden,message:i,data:e}),not_found:(i,e)=>({code:p.not_found,message:i?`${i} not found`:"not found",data:e}),conflict:(i="conflict",e)=>({code:p.conflict,message:i,data:e}),validation_error:(i="validation error",e)=>({code:p.validation_error,message:i,data:e}),rate_limited:(i="rate limited",e)=>({code:p.rate_limited,message:i,data:e}),service_unavailable:(i="service unavailable",e)=>({code:p.service_unavailable,message:i,data:e}),timeout:(i="timeout",e)=>({code:p.timeout,message:i,data:e}),ai_provider_error:(i,e,t)=>({code:p.ai_provider_error,message:i&&e?`${i}: ${e}`:i?`${i}: error`:e??"ai provider error",data:t})};class M extends Error{code;data;constructor(e,t,s,a){super(t,a),this.code=e,this.data=s}}const Or=(i,e,t)=>{const s={jsonrpc:$,id:t,method:i};return e!==void 0&&(s.params=e),s},Rr=(i,e)=>({jsonrpc:$,id:i,result:e}),Sr=(i,e)=>{const t={jsonrpc:$,method:i};return e!==void 0&&(t.params=e),t},T=(i,e)=>({jsonrpc:$,id:i,error:e}),Ae=(i,e)=>{let t=p.internal_error,s="internal server error",a;return e instanceof M?(t=e.code,s=e.message,a=e.data):e instanceof Error&&(s=e.message),{jsonrpc:$,id:i,error:{code:t,message:s,data:a}}},P=i=>{if(!i)return null;const e=typeof i=="object"?i.id:i;return Pr(e)?e:null},Pr=i=>{const e=typeof i;return e==="string"||e==="number"&&!Number.isNaN(i)&&Number.isFinite(i)},we=i=>typeof i=="object"&&i!==null&&!Array.isArray(i)&&i.jsonrpc===$,_e=i=>we(i)&&"method"in i&&"id"in i,je=i=>we(i)&&"method"in i&&!("id"in i),$r=i=>we(i)&&"result"in i&&"id"in i,qt=i=>we(i)&&"error"in i&&"id"in i,Nt=i=>{if(i!=null)return typeof i=="object"&&!Array.isArray(i)?i:{value:i}},jr=i=>i==null?{}:typeof i=="object"&&!Array.isArray(i)?i:{value:i},Ss=[[p.parse_error,400],[p.invalid_request,400],[p.method_not_found,404],[p.invalid_params,400],[p.internal_error,500],[p.unauthenticated,401],[p.forbidden,403],[p.not_found,404],[p.conflict,409],[p.validation_error,422],[p.rate_limited,429],[p.service_unavailable,503],[p.timeout,504],[p.ai_provider_error,502]];Object.fromEntries(Ss);const zr=Object.fromEntries(Ss.map(([i,e])=>[e,i])),Nr=i=>zr[i]||p.internal_error;class Jr{#e;#t=new Set;environment;spec;get data(){return this.#e}get app(){if(this.environment.executor!=="frontend")throw new Error("`action_event.app` can only be accessed in frontend environments");return this.environment}get backend(){if(this.environment.executor!=="backend")throw new Error("`action_event.backend` can only be accessed in backend environments");return this.environment}constructor(e,t,s){this.environment=e,this.spec=t,this.#e=s}toJSON(){return structuredClone(this.#e)}observe(e){return this.#t.add(e),()=>this.#t.delete(e)}set_data(e){const t=this.#e;this.#e=e;for(const s of this.#t)s(e,t,this)}parse(){if(this.#e.step!=="initial")throw new Error(`cannot parse from step '${this.#e.step}' - must be 'initial'`);if(qt(this.#e.response))return this.#e.kind==="request_response"&&this.#e.phase==="receive_response"?(this.#a("receive_error",this.#e.response.error),this):(this.#r(this.#e.response.error),this);const e=Dr(this.spec.method,this.#e.input);return e.success?this.#s("parsed",{input:e.data}):this.#r(R.invalid_params(`failed to parse input: ${Rt(e.error)}`,{validation_errors:e.error.issues})),this}async handle_async(){if(this.#e.step==="failed")return;if(this.#e.step!=="parsed")throw new Error(`cannot handle from step '${this.#e.step}' - must be 'parsed'`);this.#s("handling",this.#l());const e=this.environment.lookup_action_handler(this.spec.method,this.#e.phase);if(!e){this.#s("handled");return}try{const t=await e(this);this.#_(t)}catch(t){const s=t instanceof M?{code:t.code,message:t.message,data:t.data}:R.internal_error(V);if(this.#e.phase==="send_error"||this.#e.phase==="receive_error")this.#r(s);else{const a=this.#n();a?this.#a(a,s):this.#r(s)}}}handle_sync(){if(this.spec.kind!=="local_call"||this.spec.async)throw new Error("handle_sync can only be used with synchronous local_call actions");if(this.#e.step==="failed")return;if(this.#e.step!=="parsed")throw new Error(`cannot handle from step '${this.#e.step}' - must be 'parsed'`);this.#s("handling",this.#l());const e=this.environment.lookup_action_handler(this.spec.method,this.#e.phase);if(!e){this.#s("handled");return}try{const t=e(this);this.#_(t)}catch(t){const s=t instanceof M?{code:t.code,message:t.message,data:t.data}:R.internal_error(V);this.#r(s)}}transition(e){if(this.#e.step==="failed")return;if(this.#e.step!=="handled")throw new Error(`cannot transition from step '${this.#e.step}' - must be 'handled'`);er(this.#e.phase,e);const t=this.#d(e);this.set_data(t)}is_complete(){return Se(this.#e)}update_progress(e){this.#i({progress:e})}set_request(e){this.#o("request",{kind:"request_response",phase:"receive_request"}),this.#i({request:e})}set_response(e){this.#o("response",{kind:"request_response",phase:"receive_response"});const t="result"in e?e.result:null;this.#i({response:e,output:t})}set_notification(e){this.#o("notification",{kind:"remote_notification",phase:"receive"}),this.#i({notification:e})}#s(e,t){Zi(this.#e.step,e),this.#i({...t,step:e})}#i(e){const t={...this.#e,...e};this.set_data(t)}#r(e){this.#s("failed",{error:e})}#n(){if(this.#e.kind!=="request_response")return null;switch(this.#e.phase){case"send_request":case"receive_request":return"send_error";case"receive_response":return"receive_error";default:return null}}#a(e,t){const s={...this.#e,phase:e,step:"parsed",error:t,output:null};this.set_data(s)}#o(e,t){if(this.#e.kind!==t.kind||this.#e.phase!==t.phase)throw new Error(`can only set ${e} in ${t.phase} phase`);if(this.#e.step!=="initial")throw new Error(`can only set ${e} at initial step`)}#l(){if(Ki(this.#e))return{request:Or(this.spec.method,Nt(this.#e.input),E())};if(Qi(this.#e))return{notification:Sr(this.spec.method,Nt(this.#e.input))}}#_(e){if(e!==void 0&&sr(this.spec.kind,this.#e.phase)){const t=Ar(this.spec.method,e);t.success?this.#s("handled",{output:t.data}):this.#r(R.validation_error(`failed to parse output: ${Rt(t.error)}`,{output:e,validation_errors:t.error.issues}))}else this.#s("handled")}#d(e){const t=fs(this.#e.kind,e,this.#e.method,this.#e.executor,this.#e.input);if(jt(this.#e)){if(e==="receive_response"&&this.#e.request)return{...t,request:this.#e.request};if(e==="send_response"&&this.#e.request){const s=this.#c();return{...t,output:this.#e.output,request:this.#e.request,response:s}}else{if(e==="send_error"&&this.#e.error)return{...t,error:this.#e.error,request:this.#e.request||null};if(e==="receive_error"&&this.#e.error)return{...t,error:this.#e.error,request:this.#e.request,response:this.#e.response}}}return t}#c(){if(!jt(this.#e)||!this.#e.request)throw new Error("cannot create response without request");if(this.#e.error)return T(this.#e.request.id,this.#e.error);const e=jr(this.#e.output);return Rr(this.#e.request.id,e)}}const Y=(i,e,t,s)=>{const a=s||tr(e.kind,e.initiator,i.executor);if(!a)throw new Error(`executor '${i.executor}' cannot initiate action '${e.method}' with initiator '${e.initiator}'`);const d=fs(e.kind,a,e.method,i.executor,t);return new Jr(i,e,d)};_();class Cr{#e=null;#t=new Map;allow_fallback=!0;register_transport(e){this.#t.set(e.transport_name,e),this.#e||(this.#e=e)}set_current_transport(e){const t=this.#t.get(e);if(!t)throw new Error(`transport not registered: ${e}`);this.#e=t}get_transport(e){return this.allow_fallback?this.#i(e):this.#s(e)}is_ready(){const e=this.#e;return e?e.is_ready():null}get_current_transport(){return this.#e??null}get_current_transport_name(){return this.#e?.transport_name??null}get_transport_by_name(e){return this.#t.get(e)??null}#s(e){const t=e?this.#t.get(e):this.#e;return t?.is_ready()?t:null}#i(e){if(e){const t=Array.isArray(e)?e:[e];for(const s of t){const a=this.#t.get(s);if(a?.is_ready())return a}}if(this.#e?.is_ready())return this.#e;for(const t of this.#t.values())if(t.is_ready())return t;return null}}class Mr{environment;transports;default_send_options;constructor(e){this.environment=e.environment,this.transports=e.transports??new Cr,this.default_send_options=e.default_send_options??{}}async send(e,t){try{const s=this.transports.get_transport(t?.transport_name??this.default_send_options.transport_name);if(!s)return this.environment.log?.error("[peer] send failed: no transport available"),T(P(e),R.service_unavailable("no transport available"));const a=_e(e)?"request":"notification";this.environment.log?.debug(`[peer] send ${a}:`,e.method,`via ${s.transport_name}`);const d=await s.send(e);return d&&"error"in d&&this.environment.log?.error(`[peer] send ${a} failed:`,e.method,d.error.message),d}catch(s){return this.environment.log?.error("[peer] send unexpected error:",s),Ae(P(e),s)}}async receive(e){try{return await this.#e(e)}catch(t){return this.environment.log?.error("[peer] receive unexpected error:",t),Ae(P(e),t)}}async#e(e){return _e(e)?this.#t(e):je(e)?(await this.#s(e),null):T(P(e),R.invalid_request())}async#t(e){const t=this.environment.lookup_action_spec(e.method);if(!t)return this.environment.log?.warn("[peer] receive request: method not found:",e.method),T(e.id,R.method_not_found(e.method));this.environment.log?.debug("[peer] receive request:",e.method);try{const s=Y(this.environment,t,e.params,"receive_request");return s.set_request(e),await s.parse().handle_async(),s.data.step==="handled"&&(s.transition("send_response"),await s.parse().handle_async(),s.data.response)?s.data.response:s.data.step==="failed"?(this.environment.log?.error("[peer] receive request failed:",e.method,s.data.error),T(e.id,s.data.error)):s.data.phase==="send_error"?(await s.handle_async(),T(e.id,s.data.error)):(this.environment.log?.error("[peer] receive request: unexpected state:",e.method,s.data),T(e.id,R.internal_error(V)))}catch(s){return this.environment.log?.error("[peer] receive request exception:",e.method,s),Ae(e.id,s)}}async#s(e){const t=this.environment.lookup_action_spec(e.method);if(!t){this.environment.log?.warn("[peer] receive notification: method not found:",e.method);return}this.environment.log?.debug("[peer] receive notification:",e.method);try{const s=Y(this.environment,t,e.params,"receive");s.set_notification(e),await s.parse().handle_async(),s.data.step==="failed"&&this.environment.log?.error("[peer] receive notification failed:",e.method,s.data.error)}catch(s){this.environment.log?.error("[peer] receive notification exception:",e.method,s)}}}const Ir=i=>new Proxy({},{get(e,t){const s=i.lookup_action_spec(t);if(s)return Lr(i,s)},has(e,t){return i.lookup_action_spec(t)!==void 0}}),Lr=(i,e)=>{switch(e.kind){case"local_call":return e.async?Fr(i,e):Ur(i,e);case"request_response":return Wr(i,e);case"remote_notification":return Vr(i,e)}},Ur=(i,e)=>t=>{const s=Y(i,e,t);i.actions?.add_from_json({method:e.method,action_event_data:s.toJSON()})?.listen_to_action_event(s),s.parse().handle_sync();const d=F(s);if(d.ok)return d.value;throw new Error(`${e.method} failed: ${d.error.message}`)},Fr=(i,e)=>async t=>{const s=Y(i,e,t);return i.actions?.add_from_json({method:e.method,action_event_data:s.toJSON()})?.listen_to_action_event(s),await s.parse().handle_async(),F(s)},Wr=(i,e)=>async t=>{const s=Y(i,e,t);if(i.actions?.add_from_json({method:e.method,action_event_data:s.toJSON()})?.listen_to_action_event(s),await s.parse().handle_async(),s.data.kind==="request_response"&&s.data.phase==="send_error")return await s.handle_async(),F(s);if(!ps(s.data))throw Error();if(s.data.step!=="handled")return F(s);const d=await i.peer.send(s.data.request);return s.transition("receive_response"),s.set_response(d),s.parse(),await s.handle_async(),F(s)},Vr=(i,e)=>async t=>{const s=Y(i,e,t);if(i.actions?.add_from_json({method:e.method,action_event_data:s.toJSON()})?.listen_to_action_event(s),await s.parse().handle_async(),!ms(s.data))throw Error();if(s.data.step==="handled"){const d=await i.peer.send(s.data.notification);return d!==null?(i.log?.error("notification send failed:",d.error),{ok:!1,error:d.error}):{ok:!0,value:void 0}}return F(s)};class Hr{transport_name="frontend_http_rpc";#e;#t;constructor(e,t){this.#e=e,this.#t=t??{"content-type":"application/json",accept:"application/json"}}async send(e){try{const t=await fetch(this.#e,{method:"POST",headers:this.#t,body:JSON.stringify(e)}),s=await t.json();return t.ok?($s&&qt(s),s):T(P(e),{code:Nr(t.status),message:`HTTP error: ${t.status} ${t.statusText}`})}catch(t){return t instanceof M?T(P(e),{code:t.code,message:t.message,data:t.data}):T(P(e),R.internal_error("error sending request",{error:t.message||V}))}}is_ready(){return!0}}class Yr{id;deferred;created;#e=o();get status(){return r(this.#e)}set status(e){n(this.#e,e,!0)}#t=o();get timeout(){return r(this.#t)}set timeout(e){n(this.#t,e,!0)}constructor(e,t,s,a,d){this.id=e,this.deferred=t,this.created=s,this.status=a,this.timeout=d}}class Gr{pending_requests=new L;request_timeout_ms;constructor(e=12e4){this.request_timeout_ms=e}track_request(e){const t=Vs(),s=de(),a=this.pending_requests.get(e);a?.timeout&&clearTimeout(a.timeout);const d=setTimeout(()=>{this.reject_request(e,{jsonrpc:"2.0",id:e,error:{code:Qe,message:`request timed out: ${e}`}})},this.request_timeout_ms);return this.pending_requests.set(e,new Yr(e,t,s,"pending",d)),t}resolve_request(e,t){const s=this.pending_requests.get(e);if(!s){console.warn(`received response for unknown request: ${e}`);return}s.timeout&&(clearTimeout(s.timeout),s.timeout=void 0),s.status="success",s.deferred.resolve(t),this.pending_requests.delete(e)}reject_request(e,t){const s=this.pending_requests.get(e);if(!s){console.warn(`received error for unknown request: ${e}`);return}s.timeout&&(clearTimeout(s.timeout),s.timeout=void 0),s.status="failure";const a=new M(t.error.code,t.error.message,t.error.data);s.deferred.reject(a),this.pending_requests.delete(e)}handle_message(e){if(!e)return;const{id:t}=e;t!=null&&("result"in e?this.resolve_request(t,e):"error"in e&&this.reject_request(t,e))}cancel_request(e){const t=this.pending_requests.get(e);t&&(t.timeout&&(clearTimeout(t.timeout),t.timeout=void 0),this.pending_requests.delete(e))}cancel_all_requests(e){for(const[t,s]of this.pending_requests.entries())s.timeout&&(clearTimeout(s.timeout),s.timeout=void 0),s.status="failure",s.deferred.reject(new M(p.internal_error,e||"request cancelled")),this.pending_requests.delete(t)}}class Xr{transport_name="frontend_websocket_rpc";#e;#t;#s;#i;constructor(e,t){this.#e=e,this.#t=new Gr(t),this.#s=e.add_message_handler(async s=>{try{const a=JSON.parse(s.data);$r(a)||qt(a)&&a.id!==null?this.#t.handle_message(a):_e(a)||je(a)?await e.app.peer.receive(a):console.warn("[ws_transport] received unknown message type:",a)}catch(a){console.error("[ws_transport] error parsing WebSocket message:",a)}}),this.#i=e.add_error_handler(s=>{console.error("[ws_transport] WebSocket error:",s)})}async send(e){if(!this.is_ready())return T(P(e),R.service_unavailable("WebSocket not connected"));try{if(_e(e)){const t=this.#t.track_request(e.id);return this.#e.send(e),await t.promise}else if(je(e))return this.#e.send(e),null;return T(P(e),R.invalid_request())}catch(t){return t instanceof M?T(P(e),{code:t.code,message:t.message,data:t.data}):T(P(e),R.internal_error(t.message||V))}}is_ready(){return this.#e.connected}dispose(){this.#s&&(this.#s(),this.#s=null),this.#i&&(this.#i(),this.#i=null)}}const gn=Us(),Br=b.extend({ui:$e.default(()=>$e.parse({}))}).meta({cell_class_name:"Frontend"});class vn extends f{executor="frontend";cell_registry;action_registry;action_handlers;api;peer;time;ui;models;chats;threads;providers;prompts;parts;diskfiles;actions;socket;capabilities;ollama;bots;#e=o(null);get zzz_cache_dir(){return r(this.#e)}set zzz_cache_dir(e){const t=e==null?e:pe.safeParse(e);n(this.#e,t==null?t:t.data,!0)}#t=o(I([]));get provider_status(){return r(this.#t)}set provider_status(e){n(this.#t,e,!0)}#s=l(()=>{const e=new Set;for(const t of this.models.items.by_id.values())for(const s of t.tags)e.add(s);return e});get tags(){return r(this.#s)}set tags(e){n(this.#s,e)}diskfile_histories=new L;#i=o(!1);get futuremode(){return r(this.#i)}set futuremode(e){n(this.#i,e,!0)}constructor(e=Le){super(Br,e),this.app=this,this.cell_registry=new ar(this),this.action_registry=new Tr(e.action_specs||Fi),this.action_handlers=e.action_handlers||{};const t=e.cell_classes||qr;for(const s of Object.values(t))this.cell_registry.register(s);this.time=new ye({app:this}),this.ui=new Rs({app:this}),this.models=new Ft({app:this}),this.chats=new Ve({app:this}),this.threads=new Qt({app:this}),this.providers=new Zt({app:this}),this.prompts=new kt({app:this}),this.parts=new Ts({app:this}),this.diskfiles=new ss({app:this}),this.actions=new vs({app:this}),this.socket=new Os({app:this}),this.capabilities=new Ds({app:this}),this.ollama=new pr({app:this}),this.bots=e.bots??bi,this.api=Ir(this),this.peer=new Mr({environment:this}),e.socket_url&&(this.socket.connect(e.socket_url),this.peer.transports.register_transport(new Xr(this.socket))),e.http_rpc_url&&this.peer.transports.register_transport(new Hr(e.http_rpc_url,e.http_headers)),this.decoders={ui:s=>(s&&typeof s=="object"&&this.ui.set_json(s),j)},e.providers?.length&&this.add_providers(e.providers),e.models?.length&&this.models.add_many(e.models),this.init()}receive_session(e){if(this.zzz_cache_dir=e.zzz_cache_dir,this.provider_status=e.provider_status,Array.isArray(e.files))for(const t of e.files)this.diskfiles.handle_change({change:{type:"add",path:t.id},disknode:t})}add_providers(e){for(const t of e)this.add_provider(t)}add_provider(e){this.providers.add(new Mt({app:this,json:e}))}lookup_provider_status(e){return this.provider_status.find(t=>t.name===e)??null}update_provider_status(e){const t=this.lookup_provider_status(e.name);if(t){const s=this.provider_status.indexOf(t);this.provider_status[s]=e}else this.provider_status.push(e)}get_diskfile_history(e){return this.diskfile_histories.get(e)}create_diskfile_history(e){const t=new As({app:this,json:{path:e}});return this.diskfile_histories.set(e,t),t}lookup_action_handler(e,t){const s=this.action_handlers[e];if(s)return s[t]}lookup_action_spec(e){return this.action_registry.spec_by_method.get(e)}lookup_action_input_schema(e){return this.action_registry.spec_by_method.get(e)?.input}lookup_action_output_schema(e){return this.action_registry.spec_by_method.get(e)?.output}is_valid_phase_for_method(e,t){const s=this.action_registry.spec_by_method.get(e);return s?Xi[s.kind].includes(t):!1}}export{bi as B,br as D,Le as E,vn as F,z as I,Ut as M,Zs as O,be as P,un as S,We as T,or as U,H as a,Q as b,qr as c,ue as d,hn as e,gn as f,cn as g,fn as h,sn as i,dn as j,_n as k,ln as l,on as m,an as n,rn as o,nn as p,mn as q,pn as r,Ct as s,Wt as t,yr as u,wr as v,tn as w,mr as x};
